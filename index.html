<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
	<title>QR Word Match</title>
	<style>
		* { box-sizing: border-box; margin: 0; padding: 0; }
		
		/* Light theme */
		body.light { 
			background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
			color: #2c3e50;
		}
		.light header { 
			background: white;
			color: #2c3e50;
			box-shadow: 0 2px 10px rgba(0,0,0,0.1);
		}
		.light .card { 
			background: white;
			color: #2c3e50;
			box-shadow: 0 10px 30px rgba(0,0,0,0.1);
		}
		.light button { 
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
		}
		.light select, .light textarea, .light input[type="text"] {
			background: #f8f9fa;
			color: #2c3e50;
			border: 2px solid #e0e6ed;
		}
		.light .word { 
			background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
			color: white;
		}
		.light .toggle {
			background: #f0f3ff;
		}
		.light .toggle input:checked + span {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
		}
		.light .tag { 
			color: #667eea;
			background: #f0f3ff;
		}
		.light footer {
			background: white;
			color: #718096;
			box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
		}
		.light #videoContainer {
			background: white;
			box-shadow: 0 10px 30px rgba(0,0,0,0.2);
		}
		
		/* Dark theme */
		body.dark { 
			background: #0b0d12;
			color: #f7f7f7;
		}
		.dark header { 
			background: #0f131a;
			color: #f7f7f7;
			border-bottom: 1px solid #151a22;
		}
		.dark .card { 
			background: #111722;
			color: #f7f7f7;
			border: 1px solid #1c2432;
		}
		.dark button { 
			background: #1a2230;
			color: #f7f7f7;
			border: 1px solid #2a3548;
		}
		.dark button:hover {
			background: #2a3548;
		}
		.dark select, .dark textarea, .dark input[type="text"] {
			background: #0f1520;
			color: #f7f7f7;
			border: 1px solid #25324a;
		}
		.dark .word { 
			background: #0f1520;
			color: #f7f7f7;
			border: 1px dashed #25324a;
		}
		.dark .toggle {
			background: #0d1420;
			border: 1px solid #1f2a3d;
		}
		.dark .toggle input:checked + span {
			background: #1a2230;
			color: #f7f7f7;
			border: 1px solid #2a3548;
		}
		.dark .tag { 
			color: #a8b0bd;
			background: #0d1420;
			border: 1px solid #1f2a3d;
		}
		.dark footer {
			background: #0f131a;
			color: #a8b0bd;
			border-top: 1px solid #151a22;
		}
		.dark #videoContainer {
			background: #0a0f16;
			border: 1px solid #283449;
		}
		.dark .small {
			color: #a8b0bd;
		}
		.dark #err {
			color: #ff8c8c;
		}
		
		/* Common styles */
		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
			display: flex;
			flex-direction: column;
			min-height: 100vh;
			transition: background 0.3s ease;
			position: relative;
		}

		body::before {
			content: '';
			position: fixed;
			top: 0;
			left: 0;
			width: 100%;
			height: 100%;
			background-image: url('./images/background-pattern.png');
			background-repeat: repeat;
			background-size: 400px 400px;
			opacity: 0.1;
			z-index: -1;
			pointer-events: none;
		}
		header { 
			padding: 16px 20px;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}
		header h1 { 
			font-size: 24px;
			font-weight: bold;
		}
		main { 
			flex: 1;
			padding: 20px;
			display: flex;
			flex-direction: column;
			gap: 20px;
			max-width: 800px;
			margin: 0 auto;
			width: 100%;
		}
		.card { 
			border-radius: 20px;
			padding: 20px;
		}
		button { 
			border: none;
			border-radius: 12px;
			padding: 12px 20px;
			font-size: 16px;
			font-weight: 600;
			cursor: pointer;
			transition: transform 0.2s, box-shadow 0.2s;
		}
		button:hover {
			transform: translateY(-2px);
		}
		button:active { transform: translateY(0); }
		button:disabled { 
			opacity: 0.5; 
			cursor: not-allowed;
			transform: none;
		}
		select, textarea, input[type="text"] {
			border-radius: 10px;
			padding: 10px 15px;
			font-size: 16px;
		}
		select {
			cursor: pointer;
		}
		textarea {
			padding: 12px;
			font-family: monospace;
			resize: vertical;
		}
		.word { 
			font-size: clamp(36px, 8vw, 72px);
			text-align: center;
			font-weight: 900;
			padding: 30px 20px;
			border-radius: 20px;
			text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
			margin: 20px 0;
		}
		.status { 
			text-align: center;
			font-weight: 700;
			font-size: 18px;
			min-height: 30px;
			margin: 10px 0;
		}
		.status.ok { color: #00d084; }
		.status.bad { color: #ff6b6b; }
		
		#videoContainer { 
			width: 100%;
			max-width: 500px;
			margin: 20px auto;
			border-radius: 20px;
			overflow: hidden;
			position: relative;
			aspect-ratio: 4/3;
		}
		
		.camera-panel {
			display: flex;
			align-items: center;
			justify-content: center;
		}
		
		.camera-panel #videoContainer {
			margin: 0;
			max-width: 280px;
			width: 280px;
		}
		
		/* Mobile: Stack camera vertically */
		@media screen and (max-width: 767px) {
			.main-content.camera-active {
				display: flex !important;
				flex-direction: column;
			}
			
			.camera-panel {
				order: 2;
			}
			
			.camera-panel #videoContainer {
				max-width: 100%;
				width: 100%;
			}
		}
		#video { 
			width: 100%;
			height: 100%;
			object-fit: cover;
			display: block;
		}
		#canvas { display: none; }
		.scan-region {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			width: 250px;
			height: 250px;
			border: 3px solid #00d084;
			border-radius: 20px;
			box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.3);
		}
		.scan-line {
			position: absolute;
			width: 100%;
			height: 3px;
			background: linear-gradient(90deg, transparent, #00d084, transparent);
			animation: scan 2s linear infinite;
		}
		@keyframes scan {
			0% { top: 0; }
			100% { top: calc(100% - 3px); }
		}
		@keyframes pulse {
			0%, 100% { transform: scale(1); }
			50% { transform: scale(1.2); }
		}
		@keyframes bigNumber {
			0% { transform: scale(0) rotate(0deg); opacity: 0; }
			50% { transform: scale(1.5) rotate(180deg); opacity: 1; }
			100% { transform: scale(1) rotate(360deg); opacity: 1; }
		}
		
		#stars { 
			text-align: center;
			font-size: 32px;
			min-height: 40px;
			margin: 10px 0;
		}
		#pictogram {
			text-align: center;
			margin: 20px 0;
			min-height: 200px;
			display: none;
		}
		#pictogram img {
			max-width: 250px;
			height: auto;
			border-radius: 12px;
		}
		#muteBtn, #themeBtn {
			font-size: 24px;
			padding: 10px 15px;
			min-width: 60px;
		}
		#bigMilestone {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			font-size: 200px;
			font-weight: bold;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			animation: bigNumber 1s ease-out;
			pointer-events: none;
			z-index: 10000;
		}
		
		.row { 
			display: flex;
			gap: 10px;
			flex-wrap: wrap;
			align-items: center;
			margin: 10px 0;
		}
		.tag { 
			font-size: 14px;
			font-weight: 600;
			padding: 8px 16px;
			border-radius: 999px;
		}
		.selects {
			display: flex;
			gap: 10px;
			align-items: center;
			flex-wrap: wrap;
		}
		/* W3Schools Toggle Switch */
		.display-mode-label {
			font-size: 14px;
			font-weight: 600;
			margin-bottom: 8px;
			color: inherit;
		}
		
		.switch {
			position: relative;
			display: inline-block;
			width: 60px;
			height: 34px;
		}
		
		.switch input {
			opacity: 0;
			width: 0;
			height: 0;
		}
		
		.slider {
			position: absolute;
			cursor: pointer;
			top: 0;
			left: 0;
			right: 0;
			bottom: 0;
			background-color: #ccc;
			transition: .4s;
			border-radius: 34px;
		}
		
		.slider:before {
			position: absolute;
			content: "";
			height: 26px;
			width: 26px;
			left: 4px;
			bottom: 4px;
			background-color: white;
			transition: .4s;
			border-radius: 50%;
		}
		
		input:checked + .slider {
			background-color: #667eea;
		}
		
		input:focus + .slider {
			box-shadow: 0 0 1px #667eea;
		}
		
		input:checked + .slider:before {
			transform: translateX(26px);
		}
		
		/* Dark theme toggle styling */
		.dark input:checked + .slider {
			background-color: #4c51bf;
		}
		
		.dark input:focus + .slider {
			box-shadow: 0 0 1px #4c51bf;
		}
		
		/* Compact mode for camera active */
		.main-content.camera-active .switch {
			width: 45px;
			height: 26px;
		}
		
		.main-content.camera-active .slider:before {
			height: 20px;
			width: 20px;
			left: 3px;
			bottom: 3px;
		}
		
		.main-content.camera-active input:checked + .slider:before {
			transform: translateX(19px);
		}
		
		.main-content.camera-active .display-mode-label {
			font-size: 12px;
			margin-bottom: 6px;
		}
		details {
			margin: 10px 0;
		}
		details summary {
			cursor: pointer;
			user-select: none;
			font-weight: bold;
			font-size: 18px;
			padding: 10px 0;
		}
		details summary:hover {
			color: #667eea;
		}
		footer {
			padding: 16px;
			text-align: center;
			font-size: 14px;
		}
		#err {
			font-size: 14px;
			margin: 10px 0;
		}
		.small {
			font-size: 13px;
		}
		#loadingMsg {
			text-align: center;
			padding: 20px;
			font-style: italic;
		}
		
		/* Portrait fallback for tablets */
		@media screen and (min-width: 768px) and (orientation: portrait) {
			.main-content {
				display: block;
			}
			
			main {
				max-width: 600px;
				margin: 0 auto;
			}
		}
		
		/* Landscape iPad optimizations */
		@media screen and (min-width: 768px) and (orientation: landscape) {
			body {
				overflow-x: hidden;
			}
			
			main {
				max-width: none;
				padding: 16px;
				gap: 16px;
			}
			
			.main-content {
				display: grid;
				grid-template-columns: 1fr 1fr;
				gap: 20px;
				align-items: start;
			}
			
			.main-content.camera-active {
				grid-template-columns: minmax(300px, 0.9fr) auto minmax(280px, 0.8fr);
				gap: 12px;
			}
			
			.game-panel {
				order: 1;
				min-width: 0; /* Allow shrinking */
			}
			
			.camera-panel {
				order: 2;
				padding: 4px;
				min-width: 280px;
			}
			
			.word-list-panel {
				order: 3;
				min-width: 0; /* Allow shrinking */
			}
			
			.word {
				font-size: clamp(28px, 6vw, 48px);
				padding: 20px 16px;
				margin: 16px 0;
			}
			
			#videoContainer {
				max-width: 400px;
				margin: 16px auto;
			}
			
			.row {
				flex-wrap: wrap;
				gap: 8px;
			}
			
			.main-content.camera-active .row {
				flex-wrap: nowrap;
				gap: 6px;
			}
			
			button {
				padding: 8px 12px;
				font-size: 13px;
			}
			
			.main-content.camera-active button {
				padding: 6px 10px;
				font-size: 12px;
			}
			
			#muteBtn, #themeBtn {
				font-size: 20px;
				padding: 8px 12px;
				min-width: 50px;
			}
			
			header h1 {
				font-size: 20px;
			}
			
			.card {
				padding: 16px;
			}
			
			.main-content.camera-active .card {
				padding: 12px;
			}
			
			.main-content.camera-active .row {
				margin: 8px 0;
			}
			
			#pictogram {
				min-height: 150px;
				margin: 16px 0;
			}
			
			#pictogram img {
				max-width: 200px;
			}
			
			.status {
				font-size: 16px;
				margin: 8px 0;
			}
			
			#stars {
				font-size: 28px;
				margin: 8px 0;
			}
			
			.tag {
				font-size: 13px;
				padding: 6px 12px;
			}
			
			textarea {
				font-size: 14px;
			}
			
			.main-content.camera-active textarea {
				font-size: 12px;
				min-height: 120px;
			}
			
			input[type="text"] {
				font-size: 14px;
				padding: 6px 10px;
			}
			
			.main-content.camera-active input[type="text"] {
				font-size: 12px;
				padding: 4px 8px;
			}
			
			details summary {
				font-size: 16px;
			}
		}
		
		/* Larger landscape screens (iPad Pro, desktop) */
		@media screen and (min-width: 1024px) and (orientation: landscape) {
			main {
				max-width: 1200px;
				margin: 0 auto;
				padding: 20px;
			}
			
			.main-content {
				grid-template-columns: 1.2fr 0.8fr;
				gap: 30px;
			}
			
			.main-content.camera-active {
				grid-template-columns: minmax(350px, 1fr) auto minmax(300px, 0.9fr);
				gap: 16px;
			}
			
			.word {
				font-size: clamp(32px, 5vw, 56px);
				padding: 24px 20px;
			}
			
			#videoContainer {
				max-width: 450px;
			}
			
			button {
				padding: 12px 20px;
				font-size: 16px;
			}
			
			.card {
				padding: 20px;
			}
		}
	</style>
</head>
<body class="light">
	<header>
		<h1>üéØ QR Word Match Game</h1>
		<button id="themeBtn" title="Toggle theme">üåô</button>
	</header>
	<main>
		<div class="main-content">
			<div class="card game-panel">
				<div class="row" style="justify-content:space-between; flex-wrap: wrap;">
					<div class="row" style="flex: 1; min-width: 0;">
						<button id="startBtn">Start camera</button>
						<button id="stopBtn" disabled>Stop</button>
						<button id="nextBtn">New word</button>
						<button id="muteBtn" title="Toggle sound">üîä</button>
					</div>
					<div class="selects" style="flex-shrink: 0;">
						<div class="display-mode-label">Word/Pictogram</div>
						<label class="switch">
							<input type="checkbox" id="displayToggle">
							<span class="slider"></span>
						</label>
					</div>
				</div>
				<div id="currentWord" class="word" aria-live="polite">gato</div>
				<div id="pictogram"></div>
				<div id="stars"></div>
				<div class="status" id="status"></div>
				
				<canvas id="canvas"></canvas>
				
				<div class="row">
					<div class="tag" id="scoreTag">Score: 0</div>
					<div class="tag" id="streakTag">Streak: 0 üî•</div>
				</div>
				<div id="err"></div>
				<details style="margin-top: 8px;">
					<summary style="cursor: pointer; font-size: 12px;">üì∑ Camera troubleshooting</summary>
					<div style="padding: 10px; font-size: 12px; line-height: 1.5;">
						<strong>If camera won't start:</strong><br>
						‚Ä¢ First time? Click "Allow" when browser asks for camera permission<br>
						‚Ä¢ Blocked before? Click lock icon in address bar ‚Üí Camera ‚Üí Allow ‚Üí Refresh<br>
						‚Ä¢ On iPhone? Use Safari (Chrome on iOS doesn't support cameras well)<br>
						‚Ä¢ Camera stuck? Try Stop then Start again<br>
						‚Ä¢ Still stuck? Refresh the page
					</div>
				</details>
			</div>
			
			<div class="card camera-panel" id="cameraPanel" style="display:none;">
				<div id="videoContainer">
					<video id="video" playsinline></video>
					<div class="scan-region">
						<div class="scan-line"></div>
					</div>
				</div>
			</div>

			<div class="card word-list-panel">
				<div class="row" style="margin-bottom: 16px;">
					<label for="studentName" style="font-weight: 600; font-size: 14px;">Student Name:</label>
					<input type="text" id="studentName" placeholder="Enter student name" 
						   style="flex: 1; padding: 8px 12px; border-radius: 8px; border: 2px solid #e0e6ed; font-size: 14px;">
				</div>
				<div class="row" style="margin-bottom: 16px;">
					<button id="newGameBtn" style="background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%); color: white; font-weight: 600;">üéÆ New Game</button>
				</div>
			<details open>
				<summary style="font-weight: bold; margin-bottom: 8px;">Word list</summary>
				<p class="small">Edit below to customize. One word per line. Duplicates are automatically removed.</p>
				<textarea id="wordList" rows="6">gato
rat√≥n
castillo
elefante
perro
tres</textarea>
				<div class="row" style="margin-top: 10px;">
					<button id="saveWords">Save list</button>
					<button id="clearWords" style="background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);">Clear list</button>
					<button id="downloadWords">Download list</button>
				</div>
				<div class="row" style="margin-top: 8px;">
					<button id="uploadBtn">Load from file</button>
					<button id="loadArasaacBtn" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">Load ARASAAC words</button>
					<input type="file" id="fileInput" accept=".txt" style="display:none;">
				</div>
				<div id="loadingMsg" style="display:none;">Loading validated words from ARASAAC...</div>
			</details>
			<details style="margin-top: 8px;">
				<summary style="cursor: pointer; font-size: 12px;">üìÅ File handling tips</summary>
				<div style="padding: 10px; font-size: 12px; line-height: 1.5;">
					<strong>iPhone/iPad:</strong><br>
					‚Ä¢ Downloads go to Files app ‚Üí Downloads folder<br>
					‚Ä¢ In Safari: Tap download icon in address bar<br>
					‚Ä¢ To load: Tap "Load from file" ‚Üí Browse ‚Üí Downloads<br><br>
					<strong>Android:</strong><br>
					‚Ä¢ Downloads go to Downloads folder<br>
					‚Ä¢ Check notification or Downloads app<br><br>
					<strong>ARASAAC Words:</strong><br>
					‚Ä¢ Click "Load ARASAAC words" to get validated Spanish words with pictograms<br>
					‚Ä¢ These words are guaranteed to have pictogram images
				</div>
			</details>
			</div>
		</div>
	</main>
	
<div id="volumePanel" style="display:none; opacity:1; transition: opacity .5s ease; position:fixed; right:12px; top:48px; z-index:9999; background:#0f1624; color:#cde3ff; border:1px solid #1f2a3d; border-radius:10px; padding:8px 10px; width:180px; box-shadow:0 10px 30px rgba(0,0,0,.35)">
  <div style="font-size:12px; margin-bottom:4px;">Volume</div>
  <input id="volumeSlider" type="range" min="0" max="1" step="0.01" value="0" style="width:100%">
</div>


<!-- Hidden Debug Panel -->
<div id="debugPanel" style="display:none; position:fixed; left:12px; bottom:12px; z-index:9999; font-size:12px;">
  <div style="background:#111722; color:#cde3ff; border:1px solid #1c2432; border-radius:12px; padding:10px 12px; min-width:260px; box-shadow:0 8px 30px rgba(0,0,0,.35)">
    <div style="font-weight:700; font-size:12px; margin-bottom:6px; display:flex; align-items:center; gap:6px;">
      <span>üß™ Debug</span>
      <button id="dbgHide" style="margin-left:auto; background:#22314a; color:#cde3ff; border-radius:6px; padding:2px 6px; border:1px solid #2b3a56; cursor:pointer;">Hide</button>
    </div>
    <div style="display:grid; grid-template-columns: repeat(3, minmax(0,1fr)); gap:6px;">
      <button id="dbgCorrect1"  style="background:#1f5f2e; border-radius:8px; padding:6px;">‚úÖ +1</button>
      <button id="dbgWrong"     style="background:#6b2a2a; border-radius:8px; padding:6px;">‚ùå Wrong</button>
      <button id="dbgReset"     style="background:#334155; border-radius:8px; padding:6px;">üîÑ Reset</button>
      <button id="dbgC3" style="background:#315238; border-radius:8px; padding:6px;">‚úÖ x3</button>
      <button id="dbgC5" style="background:#315238; border-radius:8px; padding:6px;">‚úÖ x5</button>
      <button id="dbgC10" style="background:#315238; border-radius:8px; padding:6px;">‚úÖ x10</button>
    </div>
  </div>
</div>

</main>
	<footer>
		<span class="small">Use over HTTPS for camera access. Pictograms from ARASAAC.org</span>
	</footer>

	<!-- Load QR code scanning library -->
	<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
	
	<!-- Load confetti for celebrations -->
	<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js">
// URL-based sound that respects global mute/volume
function playUrlSound(url){
  try {
    const st = (window && window.__qr_audio_state__) || { muted:true, volume:0 };
    if (st.muted || st.volume <= 0) return;
    const a = new Audio(url);
    a.volume = st.volume;
    a.play().catch(()=>{});
  } catch(e) {}
}

function playUrlSoundWithFallback(urls) {
  if (!urls || urls.length === 0) return;
  
  const st = (window && window.__qr_audio_state__) || { muted:true, volume:0 };
  if (st.muted || st.volume <= 0) return;
  
  let currentIndex = 0;
  
  function tryNextUrl() {
    if (currentIndex >= urls.length) {
      console.log('All sound URLs failed');
      return;
    }
    
    const url = urls[currentIndex];
    console.log(`Trying sound URL ${currentIndex + 1}/${urls.length}: ${url}`);
    
    try {
      const audio = new Audio(url);
      audio.volume = st.volume;
      
      audio.addEventListener('canplaythrough', () => {
        console.log(`Successfully loaded sound: ${url}`);
        audio.play().catch(e => {
          console.log(`Play failed for ${url}:`, e);
          currentIndex++;
          tryNextUrl();
        });
      }, { once: true });
      
      audio.addEventListener('error', (e) => {
        console.log(`Failed to load sound ${url}:`, e);
        currentIndex++;
        tryNextUrl();
      }, { once: true });
      
      // Start loading
      audio.load();
      
    } catch(e) {
      console.log(`Error creating audio for ${url}:`, e);
      currentIndex++;
      tryNextUrl();
    }
  }
  
  tryNextUrl();
}


/* LP_DEBUG_AND_AUDIO_BOOTSTRAP */
document.addEventListener('DOMContentLoaded', () => {
  const themeBtn = document.getElementById('themeBtn');
  const debugPanel = document.getElementById('debugPanel');
  const muteBtn = document.getElementById('muteBtn');
  const volumePanel = document.getElementById('volumePanel');
  const volumeSlider = document.getElementById('volumeSlider');
  /* DEBUG_BUTTON_WIRES */
  const dbg = {
    hide: document.getElementById('dbgHide'),
    c1: document.getElementById('dbgCorrect1'),
    wrong: document.getElementById('dbgWrong'),
    reset: document.getElementById('dbgReset'),
    c3: document.getElementById('dbgC3'),
    c5: document.getElementById('dbgC5'),
    c10: document.getElementById('dbgC10'),
  };

  function safeUpdate(ok){ try { if (typeof updateScore === 'function') updateScore(ok); } catch(e){ console.error(e); } }
  function clicks(n){
    (async ()=>{
      for (let i=0;i<n;i++){
        safeUpdate(true);
        await new Promise(r=>setTimeout(r, 120));
      }
    })();
  }
  function doReset(){
    try {
      if (typeof streak !== 'undefined') streak = 0;
      if (typeof score !== 'undefined') score = 0;
      if (typeof correctWords !== 'undefined' && correctWords && typeof correctWords.length === 'number') correctWords.length = 0;
      const scoreTagEl = document.getElementById('scoreTag');
      const streakTagEl = document.getElementById('streakTag');
      if (scoreTagEl) scoreTagEl.textContent = 'Score: ' + (typeof score!=='undefined'?score:0);
      if (streakTagEl) streakTagEl.textContent = 'Streak: ' + (typeof streak!=='undefined'?streak:0) + ' üî•';
      if (typeof updateStars === 'function') updateStars();
      if (typeof toast === 'function') toast('Debug: reset');
    } catch(e){ console.error(e); }
  }

  dbg.hide && dbg.hide.addEventListener('click', ()=>{ if (debugPanel) debugPanel.style.display='none'; });
  dbg.c1   && dbg.c1.addEventListener('click', ()=> clicks(1));
  dbg.wrong&& dbg.wrong.addEventListener('click', ()=> safeUpdate(false));
  dbg.reset&& dbg.reset.addEventListener('click', doReset);
  dbg.c3   && dbg.c3.addEventListener('click', ()=> clicks(3));
  dbg.c5   && dbg.c5.addEventListener('click', ()=> clicks(5));
  dbg.c10  && dbg.c10.addEventListener('click', ()=> clicks(10));


  // Always hide debug on load
  if (debugPanel) debugPanel.style.display = 'none';

  // ---- Long-press (4s) to reveal debug with click-guard
  let lpTimer = null;
  let lpFired = false;

  function revealDebug() {
    lpFired = true;
    if (debugPanel) debugPanel.style.display = 'block';
    try { toast && toast('Debug menu unlocked'); } catch(e) { }
  }
  function lpStart() { clearTimeout(lpTimer); lpTimer = setTimeout(revealDebug, 4000); }
  function lpEnd()   { clearTimeout(lpTimer); lpTimer = null; }

  if (themeBtn) {
    // Click guard in capture phase prevents theme toggle after long-press
    themeBtn.addEventListener('click', (e) => {
      if (lpFired) { lpFired = false; e.preventDefault(); e.stopImmediatePropagation(); }
    }, true);

    if (window.PointerEvent) {
      themeBtn.addEventListener('pointerdown', lpStart);
      themeBtn.addEventListener('pointerup', lpEnd);
      themeBtn.addEventListener('pointerleave', lpEnd);
      themeBtn.addEventListener('pointercancel', lpEnd);
    } else {
      themeBtn.addEventListener('mousedown', lpStart);
      themeBtn.addEventListener('mouseup', lpEnd);
      themeBtn.addEventListener('mouseleave', lpEnd);
      themeBtn.addEventListener('touchstart', lpStart, { passive: true });
      themeBtn.addEventListener('touchend', lpEnd);
      themeBtn.addEventListener('touchcancel', lpEnd);
    }
  }

  // ---- Volume panel show/hide (fade-out + outside click closes)
  let volTimer = null;
  function showVol() { if (!volumePanel) return; volumePanel.style.display='block'; volumePanel.style.opacity='1'; resetVolAuto(); }
  function hideVol() { if (!volumePanel) return; volumePanel.style.opacity='0'; setTimeout(()=>{ if (volumePanel.style.opacity==='0') volumePanel.style.display='none'; }, 500); }
  function resetVolAuto() { clearTimeout(volTimer); volTimer = setTimeout(hideVol, 5000); }

  if (muteBtn) {
    muteBtn.addEventListener('click', (e)=>{
      if (!volumePanel) return;
      const hidden = (volumePanel.style.display==='none' || !volumePanel.style.display);
      if (hidden) showVol(); else hideVol();
      e.stopPropagation(); // prevent outside-click handler from immediately hiding it
    });
  }
  if (volumeSlider) {
    volumeSlider.addEventListener('input', (e)=>{ resetVolAuto(); });
  }

  // Close volume panel when clicking/touching anywhere outside it (and not the mute button)
  document.addEventListener('mousedown', (e)=>{
    if (!volumePanel || volumePanel.style.display==='none') return;
    const t = e.target;
    if (t !== volumePanel && !volumePanel.contains(t) && t !== muteBtn) hideVol();
  });
  document.addEventListener('touchstart', (e)=>{
    if (!volumePanel || volumePanel.style.display==='none') return;
    const t = e.target;
    if (t !== volumePanel && !volumePanel.contains(t) && t !== muteBtn) hideVol();
  }, {passive:true});
});



function showMilestoneOverlay(stars) {
  milestonePopupShowing = true; // Pause QR scanning
  
  const name = (document.getElementById('studentName')?.value || localStorage.getItem('qr-word-game:student-name') || '').trim();
  const shout = (stars === 20) ? 'YOU WIN!' : (name ? ('KEEP GOING, ' + name.toUpperCase() + '!') : 'KEEP GOING!');

  const overlay = document.createElement('div');
  Object.assign(overlay.style, { position:'fixed', inset:'0', background:'rgba(0,0,0,.55)', display:'flex',
    alignItems:'center', justifyContent:'center', zIndex:'10001' });

  const card = document.createElement('div');
  Object.assign(card.style, { background:'#163454', color:'#d1e9ff', borderRadius:'18px', padding:'22px 18px',
    width:'min(92%, 780px)', boxShadow:'0 20px 70px rgba(0,0,0,.6)', border:'6px solid #cfd8e3',
    textAlign:'center', overflow:'hidden', boxSizing:'border-box' });

  function makeRow(cnt){
    const row = document.createElement('div');
    Object.assign(row.style, { 
      display:'flex', 
      gap:'8px', 
      justifyContent:'center', 
      alignItems:'center',
      fontSize:'32px'
    });
    for (let i=0;i<cnt;i++){ 
      const s=document.createElement('span'); 
      s.textContent='‚≠ê'; 
      s.style.display='block'; 
      s.style.textAlign='center'; 
      row.appendChild(s); 
    }
    return row;
  }
  const row1 = makeRow(Math.min(stars, 10));
  const row2 = stars>10 ? makeRow(stars-10) : null;
  const starsWrap = document.createElement('div');
  Object.assign(starsWrap.style, { 
    display:'flex', 
    flexDirection:'column', 
    gap:'8px', 
    marginBottom:'16px', 
    alignItems:'center',
    justifyContent:'center',
    width:'100%'
  });
  starsWrap.appendChild(row1); if (row2) starsWrap.appendChild(row2);

  const titleEl = document.createElement('div');
  Object.assign(titleEl.style, { fontSize:'64px', fontWeight:'800', letterSpacing:'1px', margin:'6px 0' });
  titleEl.textContent = String(stars) + ' STARS!';

  const msgEl = document.createElement('div');
  Object.assign(msgEl.style, { fontSize:'24px', fontWeight:'700', opacity:'.9', marginTop:'6px' });
  msgEl.textContent = shout;

  card.appendChild(starsWrap);
  card.appendChild(titleEl);
  card.appendChild(msgEl);

  if (stars === 20) {
    const img = document.createElement('img');
    img.src = 'https://raw.githubusercontent.com/zwickarr/QR-Teach/main/images/youwin.png';
    img.alt = 'You Win';
    img.style.maxWidth = '220px';
    img.style.marginTop = '12px';
    img.style.borderRadius = '14px';
    card.appendChild(img);
  }

  overlay.appendChild(card);
  document.body.appendChild(overlay);

  const fit = () => {
    const gap = 6;
    const inner = card.clientWidth - 40;
    const per = Math.floor((inner - gap*9) / 10);
    const size = Math.max(18, Math.min(48, per));
    const setRow = (row) => {
      if (!row) return;
      // Center by using fixed-size columns equal to star size; fewer stars => fewer columns, still centered
      const n = row.children.length;
      row.style.gridTemplateColumns = 'repeat(' + n + ', ' + size + 'px)';
      [...row.children].forEach(el => { el.style.fontSize = size+'px'; el.style.lineHeight='1'; el.style.width = size+'px'; });
    };
    setRow(row1); setRow(row2);
  };
  fit(); window.addEventListener('resize', fit, { once:true });

  try {
    // Try multiple formats for better browser compatibility
    const urls = stars === 20 
      ? [
          './sfx/Victory.flac',
          'https://raw.githubusercontent.com/zwickarr/QR-Teach/main/sfx/Victory.flac',
          'https://github.com/zwickarr/QR-Teach/raw/main/sfx/Victory.flac'
        ]
      : [
          './sfx/TadaFanfare.flac', 
          'https://raw.githubusercontent.com/zwickarr/QR-Teach/main/sfx/TadaFanfare.flac',
          'https://github.com/zwickarr/QR-Teach/raw/main/sfx/TadaFanfare.flac'
        ];
    
    console.log(`Milestone ${stars}: Attempting to play sound`);
    
    // Ensure audio state exists and is not muted
    const audioState = window.__qr_audio_state__;
    console.log('Audio state:', audioState);
    
    if (audioState && !audioState.muted && audioState.volume > 0) {
      console.log(`Audio enabled - muted: ${audioState.muted}, volume: ${audioState.volume}`);
      if (typeof playUrlSoundWithFallback === 'function') {
        console.log('Using playUrlSoundWithFallback');
        playUrlSoundWithFallback(urls);
      } else if (typeof playUrlSound === 'function') {
        console.log('Using playUrlSound fallback');
        playUrlSound(urls[0]);
      } else {
        console.log('No sound functions available');
      }
    } else {
      console.log(`Audio disabled - audioState exists: ${!!audioState}, muted: ${audioState?.muted}, volume: ${audioState?.volume}`);
      
      // Try to play anyway as fallback (since debug menu works)
      console.log('Attempting fallback sound play');
      if (typeof playUrlSoundWithFallback === 'function') {
        playUrlSoundWithFallback(urls);
      } else if (typeof playUrlSound === 'function') {
        playUrlSound(urls[0]);
      }
    }
  } catch(e) {
    console.log('Could not play milestone sound:', e);
  }

  setTimeout(() => {
    overlay.remove();
    milestonePopupShowing = false; // Resume QR scanning
  }, 3400);
}

function playUrlSound(url){
  try {
    const st = (window && window.__qr_audio_state__) || { muted:true, volume:0 };
    if (st.muted || st.volume <= 0) return;
    const a = new Audio(url);
    a.volume = st.volume;
    a.play().catch(()=>{});
  } catch(e) {}
}


/* LP_DEBUG_AND_AUDIO_BOOTSTRAP */
document.addEventListener('DOMContentLoaded', () => {
  const themeBtn = document.getElementById('themeBtn');
  const debugPanel = document.getElementById('debugPanel');
  const muteBtn = document.getElementById('muteBtn');
  const volumePanel = document.getElementById('volumePanel');
  const volumeSlider = document.getElementById('volumeSlider');
  /* DEBUG_BUTTON_WIRES */
  const dbg = {
    hide: document.getElementById('dbgHide'),
    c1: document.getElementById('dbgCorrect1'),
    wrong: document.getElementById('dbgWrong'),
    reset: document.getElementById('dbgReset'),
    c3: document.getElementById('dbgC3'),
    c5: document.getElementById('dbgC5'),
    c10: document.getElementById('dbgC10'),
  };

  function safeUpdate(ok){ try { if (typeof updateScore === 'function') updateScore(ok); } catch(e){ console.error(e); } }
  function clicks(n){
    (async ()=>{
      for (let i=0;i<n;i++){
        safeUpdate(true);
        await new Promise(r=>setTimeout(r, 120));
      }
    })();
  }
  function doReset(){
    try {
      if (typeof streak !== 'undefined') streak = 0;
      if (typeof score !== 'undefined') score = 0;
      if (typeof correctWords !== 'undefined' && correctWords && typeof correctWords.length === 'number') correctWords.length = 0;
      const scoreTagEl = document.getElementById('scoreTag');
      const streakTagEl = document.getElementById('streakTag');
      if (scoreTagEl) scoreTagEl.textContent = 'Score: ' + (typeof score!=='undefined'?score:0);
      if (streakTagEl) streakTagEl.textContent = 'Streak: ' + (typeof streak!=='undefined'?streak:0) + ' üî•';
      if (typeof updateStars === 'function') updateStars();
      if (typeof toast === 'function') toast('Debug: reset');
    } catch(e){ console.error(e); }
  }

  dbg.hide && dbg.hide.addEventListener('click', ()=>{ if (debugPanel) debugPanel.style.display='none'; });
  dbg.c1   && dbg.c1.addEventListener('click', ()=> clicks(1));
  dbg.wrong&& dbg.wrong.addEventListener('click', ()=> safeUpdate(false));
  dbg.reset&& dbg.reset.addEventListener('click', doReset);
  dbg.c3   && dbg.c3.addEventListener('click', ()=> clicks(3));
  dbg.c5   && dbg.c5.addEventListener('click', ()=> clicks(5));
  dbg.c10  && dbg.c10.addEventListener('click', ()=> clicks(10));


  // Always hide debug on load
  if (debugPanel) debugPanel.style.display = 'none';

  // ---- Long-press (4s) to reveal debug with click-guard
  let lpTimer = null;
  let lpFired = false;

  function revealDebug() {
    lpFired = true;
    if (debugPanel) debugPanel.style.display = 'block';
    try { toast && toast('Debug menu unlocked'); } catch(e) { }
  }
  function lpStart() { clearTimeout(lpTimer); lpTimer = setTimeout(revealDebug, 4000); }
  function lpEnd()   { clearTimeout(lpTimer); lpTimer = null; }

  if (themeBtn) {
    // Click guard in capture phase prevents theme toggle after long-press
    themeBtn.addEventListener('click', (e) => {
      if (lpFired) { lpFired = false; e.preventDefault(); e.stopImmediatePropagation(); }
    }, true);

    if (window.PointerEvent) {
      themeBtn.addEventListener('pointerdown', lpStart);
      themeBtn.addEventListener('pointerup', lpEnd);
      themeBtn.addEventListener('pointerleave', lpEnd);
      themeBtn.addEventListener('pointercancel', lpEnd);
    } else {
      themeBtn.addEventListener('mousedown', lpStart);
      themeBtn.addEventListener('mouseup', lpEnd);
      themeBtn.addEventListener('mouseleave', lpEnd);
      themeBtn.addEventListener('touchstart', lpStart, { passive: true });
      themeBtn.addEventListener('touchend', lpEnd);
      themeBtn.addEventListener('touchcancel', lpEnd);
    }
  }

  // ---- Volume panel show/hide (fade-out + outside click closes)
  let volTimer = null;
  function showVol() { if (!volumePanel) return; volumePanel.style.display='block'; volumePanel.style.opacity='1'; resetVolAuto(); }
  function hideVol() { if (!volumePanel) return; volumePanel.style.opacity='0'; setTimeout(()=>{ if (volumePanel.style.opacity==='0') volumePanel.style.display='none'; }, 500); }
  function resetVolAuto() { clearTimeout(volTimer); volTimer = setTimeout(hideVol, 5000); }

  if (muteBtn) {
    muteBtn.addEventListener('click', (e)=>{
      if (!volumePanel) return;
      const hidden = (volumePanel.style.display==='none' || !volumePanel.style.display);
      if (hidden) showVol(); else hideVol();
      e.stopPropagation(); // prevent outside-click handler from immediately hiding it
    });
  }
  if (volumeSlider) {
    volumeSlider.addEventListener('input', (e)=>{ resetVolAuto(); });
  }

  // Close volume panel when clicking/touching anywhere outside it (and not the mute button)
  document.addEventListener('mousedown', (e)=>{
    if (!volumePanel || volumePanel.style.display==='none') return;
    const t = e.target;
    if (t !== volumePanel && !volumePanel.contains(t) && t !== muteBtn) hideVol();
  });
  document.addEventListener('touchstart', (e)=>{
    if (!volumePanel || volumePanel.style.display==='none') return;
    const t = e.target;
    if (t !== volumePanel && !volumePanel.contains(t) && t !== muteBtn) hideVol();
  }, {passive:true});
});


function showMilestoneOverlay(stars) {
  milestonePopupShowing = true; // Pause QR scanning
  
  const name = (document.getElementById('studentName')?.value || localStorage.getItem('qr-word-game:student-name') || '').trim();
  const shout = (stars === 20) ? 'YOU WIN!' : (name ? ('KEEP GOING, ' + name.toUpperCase() + '!') : 'KEEP GOING!');

  const overlay = document.createElement('div');
  Object.assign(overlay.style, { position:'fixed', inset:'0', background:'rgba(0,0,0,.55)', display:'flex',
    alignItems:'center', justifyContent:'center', zIndex:'10001' });

  const card = document.createElement('div');
  Object.assign(card.style, { background:'#1e3a5f', color:'#d1e9ff', borderRadius:'18px', padding:'24px 20px',
    width:'min(92%, 780px)', boxShadow:'0 20px 70px rgba(0,0,0,.6)', border:'6px solid #e2e8f0',
    textAlign:'center', overflow:'hidden', boxSizing:'border-box' });

  function makeRow(cnt){
    const row = document.createElement('div');
    Object.assign(row.style, { display:'grid', gridTemplateColumns:'repeat(10, 1fr)', gap:'6px', alignItems:'center' });
    for (let i=0;i<cnt;i++){ const s=document.createElement('span'); s.textContent='‚≠ê'; s.style.display='block'; s.style.textAlign='center'; row.appendChild(s); }
    return row;
  }
  const row1 = makeRow(Math.min(stars, 10));
  const row2 = stars>10 ? makeRow(stars-10) : null;
  const starsWrap = document.createElement('div');
  Object.assign(starsWrap.style, { display:'flex', flexDirection:'column', gap:'8px', marginBottom:'8px' });
  starsWrap.appendChild(row1); if (row2) starsWrap.appendChild(row2);

  const titleEl = document.createElement('div');
  Object.assign(titleEl.style, { fontSize:'72px', fontWeight:'800', letterSpacing:'1px', margin:'6px 0' });
  titleEl.textContent = String(stars) + ' STARS!';

  const msgEl = document.createElement('div');
  Object.assign(msgEl.style, { fontSize:'28px', fontWeight:'700', opacity:'.9', marginTop:'6px' });
  msgEl.textContent = shout;

  card.appendChild(starsWrap);
  card.appendChild(titleEl);
  card.appendChild(msgEl);

  if (stars === 20) {
    const img = document.createElement('img');
    img.src = 'https://raw.githubusercontent.com/zwickarr/QR-Teach/main/images/youwin.png';
    img.alt = 'You Win';
    img.style.maxWidth = '220px';
    img.style.marginTop = '12px';
    img.style.borderRadius = '14px';
    card.appendChild(img);
  }

  overlay.appendChild(card);
  document.body.appendChild(overlay);

  const fit = () => {
    const gap = 6, inner = card.clientWidth - 40;
    const per = Math.floor((inner - gap*9) / 10);
    const size = Math.max(18, Math.min(48, per));
    [row1, row2].forEach(r => r && r.querySelectorAll('span').forEach(el => { el.style.fontSize = size+'px'; el.style.lineHeight='1'; }));
  };
  fit(); window.addEventListener('resize', fit, { once:true });

  try {
    // Try multiple formats for better browser compatibility
    const urls = stars === 20 
      ? [
          './sfx/Victory.flac',
          'https://raw.githubusercontent.com/zwickarr/QR-Teach/main/sfx/Victory.flac',
          'https://github.com/zwickarr/QR-Teach/raw/main/sfx/Victory.flac'
        ]
      : [
          './sfx/TadaFanfare.flac', 
          'https://raw.githubusercontent.com/zwickarr/QR-Teach/main/sfx/TadaFanfare.flac',
          'https://github.com/zwickarr/QR-Teach/raw/main/sfx/TadaFanfare.flac'
        ];
    
    console.log(`Milestone ${stars}: Attempting to play sound`);
    
    // Ensure audio state exists and is not muted
    const audioState = window.__qr_audio_state__;
    console.log('Audio state:', audioState);
    
    if (audioState && !audioState.muted && audioState.volume > 0) {
      console.log(`Audio enabled - muted: ${audioState.muted}, volume: ${audioState.volume}`);
      if (typeof playUrlSoundWithFallback === 'function') {
        console.log('Using playUrlSoundWithFallback');
        playUrlSoundWithFallback(urls);
      } else if (typeof playUrlSound === 'function') {
        console.log('Using playUrlSound fallback');
        playUrlSound(urls[0]);
      } else {
        console.log('No sound functions available');
      }
    } else {
      console.log(`Audio disabled - audioState exists: ${!!audioState}, muted: ${audioState?.muted}, volume: ${audioState?.volume}`);
      
      // Try to play anyway as fallback (since debug menu works)
      console.log('Attempting fallback sound play');
      if (typeof playUrlSoundWithFallback === 'function') {
        playUrlSoundWithFallback(urls);
      } else if (typeof playUrlSound === 'function') {
        playUrlSound(urls[0]);
      }
    }
  } catch(e) {
    console.log('Could not play milestone sound:', e);
  }

  setTimeout(() => {
    overlay.remove();
    milestonePopupShowing = false; // Resume QR scanning
  }, 3400);
}


// Volume panel toggle + outside click to close
(function(){
  const muteBtn = document.getElementById('muteBtn');
  const volumePanel = document.getElementById('volumePanel');
  if (!muteBtn || !volumePanel) return;
  let volTimer = null;
  function showVol(){ volumePanel.style.display='block'; volumePanel.style.opacity='1'; resetVolAuto(); }
  function hideVol(){ volumePanel.style.opacity='0'; setTimeout(()=>{ if (volumePanel.style.opacity==='0') volumePanel.style.display='none'; }, 500); }
  function resetVolAuto(){ clearTimeout(volTimer); volTimer = setTimeout(hideVol, 5000); }
  muteBtn.addEventListener('click', (e)=>{
    const hidden = (volumePanel.style.display==='none' || !volumePanel.style.display);
    if (hidden) showVol(); else hideVol();
    e.stopPropagation();
  });
  document.addEventListener('mousedown', (e)=>{
    if (volumePanel.style.display==='none') return;
    const t = e.target;
    if (t !== volumePanel && !volumePanel.contains(t) && t !== muteBtn) hideVol();
  });
  document.addEventListener('touchstart', (e)=>{
    if (volumePanel.style.display==='none') return;
    const t = e.target;
    if (t !== volumePanel && !volumePanel.contains(t) && t !== muteBtn) hideVol();
  }, {passive:true});
})();

</script>

	<script>
	// Theme management
	const themeBtn = document.getElementById('themeBtn');
	const body = document.body;
	const savedTheme = localStorage.getItem('qr-word-game:theme') || 'light';
	body.className = savedTheme;
	themeBtn.textContent = savedTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
	
	themeBtn.addEventListener('click', () => {
		const newTheme = body.className === 'light' ? 'dark' : 'light';
		body.className = newTheme;
		themeBtn.textContent = newTheme === 'light' ? 'üåô' : '‚òÄÔ∏è';
		localStorage.setItem('qr-word-game:theme', newTheme);
	});
	
	// UI Elements
	const wordEl = document.getElementById('currentWord');
	const statusEl = document.getElementById('status');
	const startBtn = document.getElementById('startBtn');
	const stopBtn = document.getElementById('stopBtn');
	const nextBtn = document.getElementById('nextBtn');
	const muteBtn = document.getElementById('muteBtn');
	const wordListTA = document.getElementById('wordList');
	const saveWordsBtn = document.getElementById('saveWords');
	const clearWordsBtn = document.getElementById('clearWords');
	const downloadWordsBtn = document.getElementById('downloadWords');
	const uploadBtn = document.getElementById('uploadBtn');
	const loadArasaacBtn = document.getElementById('loadArasaacBtn');
	const fileInput = document.getElementById('fileInput');
	const scoreTag = document.getElementById('scoreTag');
	const streakTag = document.getElementById('streakTag');
	const displayToggle = document.getElementById('displayToggle');
	const errEl = document.getElementById('err');
	const video = document.getElementById('video');
	const canvas = document.getElementById('canvas');
	const ctx = canvas.getContext('2d');
	const videoContainer = document.getElementById('videoContainer');
	const starsEl = document.getElementById('stars');
	const pictogramEl = document.getElementById('pictogram');
	const loadingMsg = document.getElementById('loadingMsg');
	const studentNameInput = document.getElementById('studentName');
	const newGameBtn = document.getElementById('newGameBtn');

	// State
	const LS_KEY = "qr-word-game:list";
	const LS_MUTED = "qr-word-game:muted";
	const LS_DISPLAY = "qr-word-game:display";
	const LS_GAME_STATE = "qr-word-game:game-state";
	let stream = null;
	let scanning = false;
	let score = 0, streak = 0;
	let lastText = null;
	let scanInterval = null;
	let barcodeDetector = null;
	let isMuted = localStorage.getItem(LS_MUTED) === 'true';
	let audioContext = null;
	let correctWords = [];
	let displayMode = localStorage.getItem(LS_DISPLAY) || 'word';
	let currentPictogramId = null;
	let milestonePopupShowing = false;
	
	// Initialize display mode (Word = unchecked, Pictogram = checked)
	displayToggle.checked = displayMode === 'pictogram';
	
	// Initialize mute button
	muteBtn.textContent = isMuted ? 'üîá' : 'üîä';
	
	// Initialize student name
	const savedStudentName = localStorage.getItem('qr-word-game:student-name') || '';
	if (studentNameInput) {
		studentNameInput.value = savedStudentName;
		studentNameInput.addEventListener('input', () => {
			localStorage.setItem('qr-word-game:student-name', studentNameInput.value);
		});
	}
	
	// Game state persistence functions
	function saveGameState() {
		try {
			const gameState = {
				score: score,
				streak: streak,
				correctWords: correctWords,
				timestamp: Date.now()
			};
			localStorage.setItem(LS_GAME_STATE, JSON.stringify(gameState));
		} catch(e) {
			console.log('Could not save game state');
		}
	}
	
	function loadGameState() {
		try {
			const saved = localStorage.getItem(LS_GAME_STATE);
			if (saved) {
				const gameState = JSON.parse(saved);
				// Only load if saved within last 24 hours
				if (Date.now() - gameState.timestamp < 24 * 60 * 60 * 1000) {
					score = gameState.score || 0;
					streak = gameState.streak || 0;
					correctWords = gameState.correctWords || [];
					
					// Update UI
					scoreTag.textContent = "Score: " + score;
					streakTag.textContent = "Streak: " + streak + " üî•";
					updateStars();
					
					return true;
				}
			}
		} catch(e) {
			console.log('Could not load game state');
		}
		return false;
	}
	
	// Load saved game state on startup
	loadGameState();
	
	// Save game state when page becomes hidden (user switches apps/tabs)
	document.addEventListener('visibilitychange', () => {
		if (document.hidden) {
			saveGameState();
		}
	});
	
	// Save game state before page unload
	window.addEventListener('beforeunload', saveGameState);
	
	// New Game functionality
	function newGame() {
		if (confirm("Start a new game? This will reset your score, streak, and stars.")) {
			// Reset game state
			score = 0;
			streak = 0;
			correctWords = [];
			
			// Update UI
			scoreTag.textContent = "Score: " + score;
			streakTag.textContent = "Streak: " + streak + " üî•";
			updateStars();
			
			// Save the reset state
			saveGameState();
			
			// Set new word
			setWord(randomWord());
			
			toast("üéÆ New game started!");
		}
	}
	
	// Add event listener for New Game button
	if (newGameBtn) {
		newGameBtn.addEventListener('click', newGame);
	}
	
	// Sound generation
	function initAudio() {
		if (!audioContext) {
			audioContext = new (window.AudioContext || window.webkitAudioContext)();
		}
	}
	
	function playSound(frequency, duration, type = 'sine') {
		const __state = (window && window.__qr_audio_state__) || { muted: true, volume: 0 };
		if (__state.muted || __state.volume <= 0) return;
		
		try {
			initAudio();
			const oscillator = audioContext.createOscillator();
			const gainNode = audioContext.createGain();
			
			oscillator.connect(gainNode);
			gainNode.connect(audioContext.destination);
			
			oscillator.type = type;
			oscillator.frequency.value = frequency;
			
			gainNode.gain.setValueAtTime(0.3 * __state.volume, audioContext.currentTime);
			gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
			
			oscillator.start(audioContext.currentTime);
			oscillator.stop(audioContext.currentTime + duration);
		} catch(e) {
			console.log('Audio not available');
		}
	}
	
	function playCorrectSound() {
		setTimeout(() => playSound(523, 0.1), 0);    // C
		setTimeout(() => playSound(659, 0.1), 100);  // E
		setTimeout(() => playSound(784, 0.2), 200);  // G
	}
	
	function playMilestoneSound() {
		setTimeout(() => playSound(523, 0.1), 0);    // C
		setTimeout(() => playSound(659, 0.1), 100);  // E
		setTimeout(() => playSound(784, 0.1), 200);  // G
		setTimeout(() => playSound(1047, 0.3), 300); // High C
	}
	
	muteBtn.addEventListener('click', () => {
		// Use the global audio state system
		const currentState = window.__qr_audio_state__;
		if (currentState) {
			const newMuted = !currentState.muted;
			currentState.setMuted(newMuted);
			if (!newMuted && currentState.volume <= 0) {
				currentState.setVolume(0.7); // Set reasonable default volume
			}
			toast(newMuted ? 'Sound muted' : 'Sound enabled');
			
			// Test sound when unmuting
			if (!newMuted) {
				setTimeout(() => playCorrectSound(), 100);
			}
		} else {
			// Fallback to old system
			isMuted = !isMuted;
			muteBtn.textContent = isMuted ? 'üîá' : 'üîä';
			localStorage.setItem(LS_MUTED, isMuted.toString());
			toast(isMuted ? 'Sound muted' : 'Sound enabled');
		}
	});
	
	// Display mode toggle
	displayToggle.addEventListener('change', () => {
		displayMode = displayToggle.checked ? 'pictogram' : 'word';
		localStorage.setItem(LS_DISPLAY, displayMode);
		updateDisplay(wordEl.textContent);
	});

	// Check for native BarcodeDetector support
	if ('BarcodeDetector' in window) {
		BarcodeDetector.getSupportedFormats().then(formats => {
			if (formats.includes('qr_code')) {
				barcodeDetector = new BarcodeDetector({ formats: ['qr_code'] });
				console.log('Using native BarcodeDetector');
			}
		});
	}

	// Word management
	function loadWords(){
		const saved = localStorage.getItem(LS_KEY);
		if(saved) wordListTA.value = saved;
		const lines = wordListTA.value.split(/[\r\n]+/).map(s=>s.trim()).filter(Boolean);
		const seen = new Set();
		return lines.filter(word => {
			const lower = word.toLowerCase();
			if (seen.has(lower)) return false;
			seen.add(lower);
			return true;
		});
	}
	
	function saveWords(){
		localStorage.setItem(LS_KEY, wordListTA.value);
		toast("Saved! Reloading to update word list...");
		setTimeout(() => {
			window.location.reload();
		}, 1000);
	}
	
	function clearWords(){
		if (confirm("Are you sure you want to clear the entire word list? This cannot be undone.")) {
			wordListTA.value = "";
			localStorage.setItem(LS_KEY, "");
			words = [];
			usedWords = [];
			toast("Word list cleared!");
			setWord("gato"); // Set default word
		}
	}
	
	// Load validated words from ARASAAC
	async function loadArasaacWords() {
		loadingMsg.style.display = 'block';
		loadArasaacBtn.disabled = true;
		
		try {
			// Common Spanish words to search for
			const searchTerms = [
				'casa', 'perro', 'gato', 'coche', '√°rbol', 'sol', 'luna', 'agua', 
				'libro', 'mesa', 'silla', 'cama', 'puerta', 'ventana', 'escuela',
				'ni√±o', 'ni√±a', 'mam√°', 'pap√°', 'comer', 'beber', 'dormir', 'jugar',
				'correr', 'saltar', 'leer', 'escribir', 'uno', 'dos', 'tres', 'cuatro',
				'cinco', 'rojo', 'azul', 'verde', 'amarillo', 'grande', 'peque√±o',
				'feliz', 'triste', 'caliente', 'fr√≠o', 'd√≠a', 'noche', 'amigo'
			];
			
			const validWords = [];
			
			// Use a proxy to avoid CORS issues
			const proxyUrl = 'https://api.allorigins.win/raw?url=';
			
			for (const term of searchTerms) {
				try {
					const url = `https://api.arasaac.org/v1/pictograms/es/bestsearch/${encodeURIComponent(term)}`;
					const response = await fetch(proxyUrl + encodeURIComponent(url));
					
					if (response.ok) {
						const data = await response.json();
						if (data && data.length > 0) {
							validWords.push(term);
						}
					}
				} catch (e) {
					console.log(`Could not validate: ${term}`);
				}
				
				// Small delay to avoid overwhelming the API
				await new Promise(resolve => setTimeout(resolve, 100));
			}
			
			if (validWords.length > 0) {
				wordListTA.value = validWords.join('\n');
				saveWords();
				toast(`Loaded ${validWords.length} validated ARASAAC words!`);
			} else {
				// Fallback to known good words
				const fallbackWords = [
					'gato', 'perro', 'casa', 'sol', 'luna', 'agua', '√°rbol',
					'libro', 'mesa', 'silla', 'coche', 'ni√±o', 'ni√±a',
					'comer', 'dormir', 'jugar', 'uno', 'dos', 'tres'
				];
				wordListTA.value = fallbackWords.join('\n');
				saveWords();
				toast('Loaded default ARASAAC words');
			}
		} catch (error) {
			console.error('Error loading ARASAAC words:', error);
			toast('Could not load ARASAAC words');
		} finally {
			loadingMsg.style.display = 'none';
			loadArasaacBtn.disabled = false;
		}
	}
	
	loadArasaacBtn.addEventListener('click', loadArasaacWords);
	
	function downloadWords(){
		const text = wordListTA.value;
		const timestamp = new Date().toISOString().slice(0, 10);
		const filename = `qr-words-${timestamp}.txt`;
		
		if (navigator.share && /mobile|android|iphone|ipad/i.test(navigator.userAgent)) {
			const blob = new Blob([text], { type: 'text/plain' });
			const file = new File([blob], filename, { type: 'text/plain' });
			
			navigator.share({
				files: [file],
				title: 'QR Word List',
				text: 'Word list for QR matching game'
			}).then(() => {
				toast("Shared successfully!");
			}).catch(err => {
				if (err.name !== 'AbortError') {
					fallbackDownload(text, filename);
				}
			});
		} else {
			fallbackDownload(text, filename);
		}
	}
	
	function fallbackDownload(text, filename) {
		const blob = new Blob([text], { type: 'text/plain' });
		const url = URL.createObjectURL(blob);
		const a = document.createElement('a');
		a.href = url;
		a.download = filename;
		a.style.display = 'none';
		document.body.appendChild(a);
		a.click();
		setTimeout(() => {
			document.body.removeChild(a);
			URL.revokeObjectURL(url);
		}, 100);
		toast("Downloaded: " + filename);
	}
	
	function loadFromFile(e){
		const file = e.target.files[0];
		if (!file) return;
		
		const reader = new FileReader();
		reader.onload = function(event) {
			wordListTA.value = event.target.result;
			saveWords();
			words = loadWords();
			usedWords = [];
			toast("Loaded " + words.length + " words from file!");
			setWord(randomWord());
		};
		reader.readAsText(file);
	}
	
	saveWordsBtn.addEventListener('click', saveWords);
	clearWordsBtn.addEventListener('click', clearWords);
	downloadWordsBtn.addEventListener('click', downloadWords);
	uploadBtn.addEventListener('click', () => fileInput.click());
	fileInput.addEventListener('change', loadFromFile);

	let words = loadWords();
	let usedWords = [];
	
	function randomWord(){ 
		if(words.length===0){words=["gato"];} 
		
		if (usedWords.length >= words.length) {
			usedWords = [];
			console.log('All words used, resetting list');
		}
		
		const availableWords = words.filter(w => !usedWords.includes(w));
		const word = availableWords[Math.floor(Math.random() * availableWords.length)];
		usedWords.push(word);
		
		return word;
	}
	
	function setWord(w){ 
		lastText = null;
		updateDisplay(w);
	}
	
	function updateDisplay(word) {
		wordEl.textContent = word;
		statusEl.textContent = ""; 
		statusEl.className = "status";
		
		if (displayMode === 'pictogram') {
			wordEl.style.display = 'none';
			pictogramEl.style.display = 'block';
			fetchPictogramFromAPI(word);
		
    // OVERRIDE pictogram by word if present
    (function(){
      try {
        const key = __normKey(wordEl && wordEl.textContent || '');
        if (ARASAAC_OVERRIDES.hasOwnProperty(key)) {
          const id = ARASAAC_OVERRIDES[key];
          const worker = (typeof window !== 'undefined' && window.__arasaac_worker_base__) || "";
          const src = worker ? (worker.replace(/\/$/,'') + '/pictos/' + id + '.png')
                             : ('https://static.arasaac.org/pictograms/' + id + '/' + id + '_300.png');
          if (pictogramImg) { pictogramImg.src = src; pictogramImg.dataset.arasaacId = String(id); }
        }
      } catch(e) {}
    })();
} else {
			wordEl.style.display = 'block';
			pictogramEl.style.display = 'none';
		}
	}
	
	// Fetch pictogram using ARASAAC API with bestsearch (with caching and rate limiting)
	const pictogramCache = new Map();
	let lastAPICall = 0;
	const API_DELAY = 500; // Minimum 500ms between API calls
	
// --- ARASAAC ID overrides (force specific pictogram IDs for certain words) ---
const ARASAAC_OVERRIDES = {
  // Use normalized keys (lowercase, no accents) for robustness
  "papa": 31146  // "pap√°"
};
function __normKey(s){
  try { return (s||'').toLowerCase().normalize('NFD').replace(/\p{Diacritic}+/gu, ''); } catch(e) {
    // Fallback without unicode regex
    return (s||'').toLowerCase()
      .normalize('NFD')
      .replace(/[\u0300-\u036f]/g, '');
  }
}
async function fetchPictogramFromAPI(word) {
		pictogramEl.innerHTML = '<div>Loading pictogram...</div>';
		
		try {
			const cleanWord = word.toLowerCase().trim();
			
			// Check cache first
			if (pictogramCache.has(cleanWord)) {
				const cachedId = pictogramCache.get(cleanWord);
				displayPictogram(cachedId, word);
				return;
			}
			
			// Rate limiting - wait if needed
			const now = Date.now();
			const timeSinceLastCall = now - lastAPICall;
			if (timeSinceLastCall < API_DELAY) {
				await new Promise(resolve => setTimeout(resolve, API_DELAY - timeSinceLastCall));
			}
			lastAPICall = Date.now();
			
			// Try using a CORS proxy for the API call
			const proxyUrl = 'https://api.allorigins.win/raw?url=';
			const apiUrl = `https://api.arasaac.org/v1/pictograms/es/bestsearch/${encodeURIComponent(cleanWord)}`;
			
			try {
				const response = await fetch(proxyUrl + encodeURIComponent(apiUrl));
				
				if (response.ok) {
					const items = await response.json();
					
					if (items && items.length > 0) {
						// Use the first result
						const pictogramId = items[0]._id || items[0].id;
						pictogramCache.set(cleanWord, pictogramId);
						displayPictogram(pictogramId, word);
						return;
					}
				}
			} catch (e) {
				console.log('API call failed, using fallback');
			}
			
			// Use fallback if API fails
			useFallbackPictogram(cleanWord, word);
			
		} catch (error) {
			console.error('Error loading pictogram:', error);
			pictogramEl.innerHTML = `<div style="font-size: 48px; font-weight: bold;">${word}</div>`;
		}
	}
	
	function displayPictogram(pictogramId, word) {
		currentPictogramId = pictogramId;
		
		// Direct PNG URL (500px version)
		const imgUrl = `https://static.arasaac.org/pictograms/${pictogramId}/${pictogramId}_500.png`;
		
		pictogramEl.innerHTML = `
			<img src="${imgUrl}" 
				 alt="${word}" 
				 onerror="this.onerror=null; this.src='https://api.arasaac.org/v1/pictograms/${pictogramId}?download=false&color=true';">
		`;
		
		console.log(`Loaded pictogram for "${word}" with ID: ${pictogramId}`);
	}
	
	function useFallbackPictogram(cleanWord, word) {
		// Fallback to hardcoded IDs if API fails
		const fallbackIds = {
			'gato': 7114,
			'perro': 2517,
			'rat√≥n': 2546,
			'raton': 2546,
			'castillo': 5421,
			'elefante': 2372,
			'tres': 2629,
			'casa': 2433,
			'sol': 2435,
			'luna': 2411,
			'agua': 2244,
			'√°rbol': 2418,
			'arbol': 2418,
			'libro': 2390,
			'mesa': 2412,
			'silla': 2632,
			'coche': 2446,
			'uno': 2627,
			'dos': 2628,
			'cuatro': 2630,
			'cinco': 2631
		};
		
		const fallbackId = fallbackIds[cleanWord];
		if (fallbackId) {
			pictogramCache.set(cleanWord, fallbackId);
			displayPictogram(fallbackId, word);
		} else {
			// Show emoji or text fallback
			const emojiMap = {
				'gato': 'üê±', 'perro': 'üêï', 'rat√≥n': 'üê≠', 'elefante': 'üêò',
				'casa': 'üè†', 'castillo': 'üè∞', 'sol': '‚òÄÔ∏è', 'luna': 'üåô',
				'estrella': '‚≠ê', '√°rbol': 'üå≥', 'agua': 'üíß', 'fuego': 'üî•',
				'coche': 'üöó', 'libro': 'üìö', 'pelota': '‚öΩ'
			};
			
			const emoji = emojiMap[cleanWord];
			if (emoji) {
				pictogramEl.innerHTML = `<div style="font-size: 120px;">${emoji}</div>`;
			} else {
				pictogramEl.innerHTML = `<div style="font-size: 48px; font-weight: bold;">${word}</div>`;
			}
		}
	}

	function normalize(s){
		return s.normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase().trim();
	}
	
	function celebrate(){
		if (typeof confetti === 'function') {
			confetti({ particleCount: 90, spread: 65, origin: { y: 0.6 } });
		}
	}
	
	function megaCelebrate(){
		if (typeof confetti === 'function') {
			// Multiple bursts for big milestone
			const count = 300; // More confetti!
			const defaults = { origin: { y: 0.7 } };
			
			function fire(particleRatio, opts) {
				confetti({
					...defaults,
					...opts,
					particleCount: Math.floor(count * particleRatio)
				});
			}
			
			// Fire multiple times for huge celebration
			fire(0.25, { spread: 26, startVelocity: 55 });
			fire(0.2, { spread: 60 });
			fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
			fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
			fire(0.1, { spread: 120, startVelocity: 45 });
			
			// Extra bursts for more celebration
			setTimeout(() => {
				fire(0.25, { spread: 23, startVelocity: 45 });
				fire(0.35, { spread: 80, decay: 0.91 });
			}, 200);
			
			setTimeout(() => {
				fire(0.25, { spread: 26, startVelocity: 65 });
			}, 400);
		}
	}
	
	function showBigNumber(num) {
		const el = document.createElement('div');
		el.id = 'bigMilestone';
		el.textContent = num;
		document.body.appendChild(el);
		setTimeout(() => el.remove(), 1500);
	}
	
	
function updateStars() {
  const total = correctWords.length;
  const count = Math.min(total, 20);
  const row1 = Math.min(count, 10);
  const row2 = Math.max(0, count - 10);

  const wrap = document.createElement('div');
  wrap.style.display = 'flex';
  wrap.style.flexDirection = 'column';
  wrap.style.gap = '6px';
  wrap.style.alignItems = 'center';

  function makeRow(n){
    const r = document.createElement('div');
    r.style.display = 'grid';
    r.style.gridTemplateColumns = 'repeat(10, 1fr)';
    r.style.gap = '6px';
    r.style.alignItems = 'center';
    for (let i=0;i<n;i++){ const s=document.createElement('span'); s.textContent='‚≠ê'; s.style.display='block'; s.style.textAlign='center'; r.appendChild(s); }
    return r;
  }

  const r1 = makeRow(row1);
  wrap.appendChild(r1);
  let r2 = null;
  if (row2 > 0) { r2 = makeRow(row2); wrap.appendChild(r2); }

  starsEl.innerHTML = '';
  starsEl.appendChild(wrap);

  const size = () => {
    const gap = 6;
    const inner = Math.max(160, Math.min(starsEl.clientWidth || window.innerWidth*0.9, 600)) - 20;
    const per = Math.floor((inner - gap*9) / 10);
    const target = Math.max(18, Math.min(40, per));
    [r1, r2].forEach(row => {
      if (!row) return;
      row.querySelectorAll('span').forEach(el => { el.style.fontSize = target + 'px'; el.style.lineHeight = '1'; });
    });
  };
  size(); setTimeout(size, 0);
}
	
	function updateScore(ok){
		if(ok){ 
			score += 1; 
			streak += 1;
			correctWords.push(wordEl.textContent);
    const totalCorrect = correctWords.length;
			updateStars();

    /* total-milestones */
    if ([3,5,10,15,20].includes(totalCorrect)) {
      showMilestoneOverlay(totalCorrect);
      if (totalCorrect === 20) {
        setTimeout(()=>{
          try { streak=0; score=0; correctWords.length=0; scoreTag.textContent='Score: '+score; streakTag.textContent='Streak: '+streak+' üî•'; updateStars(); saveGameState(); if (typeof setWord==='function'&& typeof randomWord==='function') setWord(randomWord()); } catch(e) {}
        }, 3400);
      }
    }
			
			playCorrectSound();
			
			if (streak === 3) {
				toast("üéâ 3 in a row! Great job!");
				celebrate();
			} else if (streak === 10) {
				toast("üèÜ 10 STREAK! AMAZING!");
				megaCelebrate();
				playMilestoneSound();
			} else if (streak === 20) {
				toast("üåü 20 STREAK! YOU'RE A CHAMPION!");
				megaCelebrate();
				playMilestoneSound();
			} else if (streak % 5 === 0 && streak > 0) {
				toast(`üî• ${streak} streak! Keep going!`);
				celebrate();
			}
		} else { 
			streak = 0; 
		}
		scoreTag.textContent = "Score: " + score;
		streakTag.textContent = "Streak: " + streak + " üî•";
		
		// Save game state after every score update
		saveGameState();
	}
	
	function toast(msg){
		const el = document.createElement('div');
		el.textContent = msg;
		el.style.cssText = "position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#111722;border:1px solid #1c2432;padding:8px 12px;border-radius:999px;color:white;box-shadow:0 8px 30px rgba(0,0,0,.4);z-index:9999";
		document.body.appendChild(el);
		setTimeout(()=> el.remove(), 2000);
	}

	// QR Code detection
	async function scanFrame() {
		if (!scanning || !video.videoWidth || milestonePopupShowing) return;

		canvas.width = video.videoWidth;
		canvas.height = video.videoHeight;
		ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

		try {
			let decodedText = null;

			if (barcodeDetector) {
				const barcodes = await barcodeDetector.detect(canvas);
				if (barcodes.length > 0) {
					decodedText = barcodes[0].rawValue;
				}
			} else if (typeof jsQR !== 'undefined') {
				const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
				const code = jsQR(imageData.data, imageData.width, imageData.height);
				if (code) {
					decodedText = code.data;
				}
			}

			if (decodedText && decodedText !== lastText) {
				lastText = decodedText;
				const currentWord = wordEl.textContent;
				const ok = normalize(decodedText) === normalize(currentWord);
				updateScore(ok);
				
				if (ok) {
					statusEl.textContent = "‚úì Correct: " + decodedText;
					statusEl.className = "status ok";
					celebrate();
					
					setTimeout(() => {
						setWord(randomWord());
						lastText = null;
					}, 1000);
				} else {
					statusEl.textContent = "‚úñ Not matched: " + decodedText;
					statusEl.className = "status bad";
				}
			}
		} catch (err) {
			// Silently handle scan errors
		}
	}

	// Camera controls - always use back camera
	async function start() {
		if (scanning) return;
		
		try {
			errEl.textContent = "";
			
			const constraints = {
				video: {
					facingMode: 'environment',
					width: { ideal: 1280 },
					height: { ideal: 720 }
				}
			};

			if (stream) {
				stream.getTracks().forEach(track => track.stop());
				stream = null;
			}

			stream = await navigator.mediaDevices.getUserMedia(constraints);
			video.srcObject = stream;
			await video.play();
			
			// Show camera panel and activate 3-column layout
			const cameraPanel = document.getElementById('cameraPanel');
			const mainContent = document.querySelector('.main-content');
			if (cameraPanel) cameraPanel.style.display = 'block';
			if (mainContent) mainContent.classList.add('camera-active');
			
			scanning = true;
			startBtn.disabled = true;
			stopBtn.disabled = false;
			nextBtn.disabled = true;

			if (scanInterval) clearInterval(scanInterval);
			scanInterval = setInterval(scanFrame, 100);
			
		} catch (err) {
			let errorMsg = "Camera error: " + (err.message || err);
			
			if (err.name === 'NotAllowedError') {
				errorMsg = `üì∑ Camera blocked. Click the lock icon in address bar ‚Üí Camera ‚Üí Allow ‚Üí Refresh`;
			} else if (err.name === 'NotFoundError') {
				errorMsg = "No camera detected";
			} else if (err.name === 'NotReadableError') {
				errorMsg = "Camera is in use by another app";
			}
			
			errEl.textContent = errorMsg;
			scanning = false;
			startBtn.disabled = false;
			stopBtn.disabled = true;
		}
	}

	async function stop() {
		if (!scanning) return;
		
		scanning = false;
		
		if (scanInterval) {
			clearInterval(scanInterval);
			scanInterval = null;
		}
		
		if (stream) {
			stream.getTracks().forEach(track => track.stop());
			stream = null;
		}
		
		video.srcObject = null;
		
		// Hide camera panel and deactivate 3-column layout
		const cameraPanel = document.getElementById('cameraPanel');
		const mainContent = document.querySelector('.main-content');
		if (cameraPanel) cameraPanel.style.display = 'none';
		if (mainContent) mainContent.classList.remove('camera-active');
		
		startBtn.disabled = false;
		stopBtn.disabled = true;
		nextBtn.disabled = false;
		lastText = null;
	}

	// Event listeners
	startBtn.addEventListener('click', start);
	stopBtn.addEventListener('click', stop);
	nextBtn.addEventListener('click', () => setWord(randomWord()));

	// Initialize
	setWord(randomWord());
	
// URL-based sound that respects global mute/volume
function playUrlSound(url){
  try {
    const st = (window && window.__qr_audio_state__) || { muted:true, volume:0 };
    if (st.muted || st.volume <= 0) return;
    const a = new Audio(url);
    a.volume = st.volume;
    a.play().catch(()=>{});
  } catch(e) {}
}


/* LP_DEBUG_AND_AUDIO_BOOTSTRAP */
document.addEventListener('DOMContentLoaded', () => {
  const themeBtn = document.getElementById('themeBtn');
  const debugPanel = document.getElementById('debugPanel');
  const muteBtn = document.getElementById('muteBtn');
  const volumePanel = document.getElementById('volumePanel');
  const volumeSlider = document.getElementById('volumeSlider');
  /* DEBUG_BUTTON_WIRES */
  const dbg = {
    hide: document.getElementById('dbgHide'),
    c1: document.getElementById('dbgCorrect1'),
    wrong: document.getElementById('dbgWrong'),
    reset: document.getElementById('dbgReset'),
    c3: document.getElementById('dbgC3'),
    c5: document.getElementById('dbgC5'),
    c10: document.getElementById('dbgC10'),
  };

  function safeUpdate(ok){ try { if (typeof updateScore === 'function') updateScore(ok); } catch(e){ console.error(e); } }
  function clicks(n){
    (async ()=>{
      for (let i=0;i<n;i++){
        safeUpdate(true);
        await new Promise(r=>setTimeout(r, 120));
      }
    })();
  }
  function doReset(){
    try {
      if (typeof streak !== 'undefined') streak = 0;
      if (typeof score !== 'undefined') score = 0;
      if (typeof correctWords !== 'undefined' && correctWords && typeof correctWords.length === 'number') correctWords.length = 0;
      const scoreTagEl = document.getElementById('scoreTag');
      const streakTagEl = document.getElementById('streakTag');
      if (scoreTagEl) scoreTagEl.textContent = 'Score: ' + (typeof score!=='undefined'?score:0);
      if (streakTagEl) streakTagEl.textContent = 'Streak: ' + (typeof streak!=='undefined'?streak:0) + ' üî•';
      if (typeof updateStars === 'function') updateStars();
      if (typeof toast === 'function') toast('Debug: reset');
    } catch(e){ console.error(e); }
  }

  dbg.hide && dbg.hide.addEventListener('click', ()=>{ if (debugPanel) debugPanel.style.display='none'; });
  dbg.c1   && dbg.c1.addEventListener('click', ()=> clicks(1));
  dbg.wrong&& dbg.wrong.addEventListener('click', ()=> safeUpdate(false));
  dbg.reset&& dbg.reset.addEventListener('click', doReset);
  dbg.c3   && dbg.c3.addEventListener('click', ()=> clicks(3));
  dbg.c5   && dbg.c5.addEventListener('click', ()=> clicks(5));
  dbg.c10  && dbg.c10.addEventListener('click', ()=> clicks(10));


  // Always hide debug on load
  if (debugPanel) debugPanel.style.display = 'none';

  // ---- Long-press (4s) to reveal debug with click-guard
  let lpTimer = null;
  let lpFired = false;

  function revealDebug() {
    lpFired = true;
    if (debugPanel) debugPanel.style.display = 'block';
    try { toast && toast('Debug menu unlocked'); } catch(e) { }
  }
  function lpStart() { clearTimeout(lpTimer); lpTimer = setTimeout(revealDebug, 4000); }
  function lpEnd()   { clearTimeout(lpTimer); lpTimer = null; }

  if (themeBtn) {
    // Click guard in capture phase prevents theme toggle after long-press
    themeBtn.addEventListener('click', (e) => {
      if (lpFired) { lpFired = false; e.preventDefault(); e.stopImmediatePropagation(); }
    }, true);

    if (window.PointerEvent) {
      themeBtn.addEventListener('pointerdown', lpStart);
      themeBtn.addEventListener('pointerup', lpEnd);
      themeBtn.addEventListener('pointerleave', lpEnd);
      themeBtn.addEventListener('pointercancel', lpEnd);
    } else {
      themeBtn.addEventListener('mousedown', lpStart);
      themeBtn.addEventListener('mouseup', lpEnd);
      themeBtn.addEventListener('mouseleave', lpEnd);
      themeBtn.addEventListener('touchstart', lpStart, { passive: true });
      themeBtn.addEventListener('touchend', lpEnd);
      themeBtn.addEventListener('touchcancel', lpEnd);
    }
  }

  // ---- Volume panel show/hide (fade-out + outside click closes)
  let volTimer = null;
  function showVol() { if (!volumePanel) return; volumePanel.style.display='block'; volumePanel.style.opacity='1'; resetVolAuto(); }
  function hideVol() { if (!volumePanel) return; volumePanel.style.opacity='0'; setTimeout(()=>{ if (volumePanel.style.opacity==='0') volumePanel.style.display='none'; }, 500); }
  function resetVolAuto() { clearTimeout(volTimer); volTimer = setTimeout(hideVol, 5000); }

  if (muteBtn) {
    muteBtn.addEventListener('click', (e)=>{
      if (!volumePanel) return;
      const hidden = (volumePanel.style.display==='none' || !volumePanel.style.display);
      if (hidden) showVol(); else hideVol();
      e.stopPropagation(); // prevent outside-click handler from immediately hiding it
    });
  }
  if (volumeSlider) {
    volumeSlider.addEventListener('input', (e)=>{ resetVolAuto(); });
  }

  // Close volume panel when clicking/touching anywhere outside it (and not the mute button)
  document.addEventListener('mousedown', (e)=>{
    if (!volumePanel || volumePanel.style.display==='none') return;
    const t = e.target;
    if (t !== volumePanel && !volumePanel.contains(t) && t !== muteBtn) hideVol();
  });
  document.addEventListener('touchstart', (e)=>{
    if (!volumePanel || volumePanel.style.display==='none') return;
    const t = e.target;
    if (t !== volumePanel && !volumePanel.contains(t) && t !== muteBtn) hideVol();
  }, {passive:true});
});


function showMilestoneOverlay(stars) {
  milestonePopupShowing = true; // Pause QR scanning
  
  const name = (document.getElementById('studentName')?.value || localStorage.getItem('qr-word-game:student-name') || '').trim();
  const shout = (stars === 20) ? 'YOU WIN!' : (name ? ('KEEP GOING, ' + name.toUpperCase() + '!') : 'KEEP GOING!');

  const overlay = document.createElement('div');
  Object.assign(overlay.style, { position:'fixed', inset:'0', background:'rgba(0,0,0,.55)', display:'flex',
    alignItems:'center', justifyContent:'center', zIndex:'10001' });

  const card = document.createElement('div');
  Object.assign(card.style, { background:'#1e3a5f', color:'#d1e9ff', borderRadius:'18px', padding:'24px 20px',
    width:'min(92%, 780px)', boxShadow:'0 20px 70px rgba(0,0,0,.6)', border:'6px solid #e2e8f0',
    textAlign:'center', overflow:'hidden', boxSizing:'border-box' });

  function makeRow(cnt){
    const row = document.createElement('div');
    Object.assign(row.style, { display:'grid', gridTemplateColumns:'repeat(10, 1fr)', gap:'6px', alignItems:'center' });
    for (let i=0;i<cnt;i++){ const s=document.createElement('span'); s.textContent='‚≠ê'; s.style.display='block'; s.style.textAlign='center'; row.appendChild(s); }
    return row;
  }
  const row1 = makeRow(Math.min(stars, 10));
  const row2 = stars>10 ? makeRow(stars-10) : null;
  const starsWrap = document.createElement('div');
  Object.assign(starsWrap.style, { display:'flex', flexDirection:'column', gap:'8px', marginBottom:'8px' });
  starsWrap.appendChild(row1); if (row2) starsWrap.appendChild(row2);

  const titleEl = document.createElement('div');
  Object.assign(titleEl.style, { fontSize:'72px', fontWeight:'800', letterSpacing:'1px', margin:'6px 0' });
  titleEl.textContent = String(stars) + ' STARS!';

  const msgEl = document.createElement('div');
  Object.assign(msgEl.style, { fontSize:'28px', fontWeight:'700', opacity:'.9', marginTop:'6px' });
  msgEl.textContent = shout;

  card.appendChild(starsWrap);
  card.appendChild(titleEl);
  card.appendChild(msgEl);

  if (stars === 20) {
    const img = document.createElement('img');
    img.src = 'https://raw.githubusercontent.com/zwickarr/QR-Teach/main/images/youwin.png';
    img.alt = 'You Win';
    img.style.maxWidth = '220px';
    img.style.marginTop = '12px';
    img.style.borderRadius = '14px';
    card.appendChild(img);
  }

  overlay.appendChild(card);
  document.body.appendChild(overlay);

  const fit = () => {
    const gap = 6, inner = card.clientWidth - 40;
    const per = Math.floor((inner - gap*9) / 10);
    const size = Math.max(18, Math.min(48, per));
    [row1, row2].forEach(r => r && r.querySelectorAll('span').forEach(el => { el.style.fontSize = size+'px'; el.style.lineHeight='1'; }));
  };
  fit(); window.addEventListener('resize', fit, { once:true });

  try {
    // Try multiple formats for better browser compatibility
    const urls = stars === 20 
      ? [
          './sfx/Victory.flac',
          'https://raw.githubusercontent.com/zwickarr/QR-Teach/main/sfx/Victory.flac',
          'https://github.com/zwickarr/QR-Teach/raw/main/sfx/Victory.flac'
        ]
      : [
          './sfx/TadaFanfare.flac', 
          'https://raw.githubusercontent.com/zwickarr/QR-Teach/main/sfx/TadaFanfare.flac',
          'https://github.com/zwickarr/QR-Teach/raw/main/sfx/TadaFanfare.flac'
        ];
    
    console.log(`Milestone ${stars}: Attempting to play sound`);
    
    // Ensure audio state exists and is not muted
    const audioState = window.__qr_audio_state__;
    console.log('Audio state:', audioState);
    
    if (audioState && !audioState.muted && audioState.volume > 0) {
      console.log(`Audio enabled - muted: ${audioState.muted}, volume: ${audioState.volume}`);
      if (typeof playUrlSoundWithFallback === 'function') {
        console.log('Using playUrlSoundWithFallback');
        playUrlSoundWithFallback(urls);
      } else if (typeof playUrlSound === 'function') {
        console.log('Using playUrlSound fallback');
        playUrlSound(urls[0]);
      } else {
        console.log('No sound functions available');
      }
    } else {
      console.log(`Audio disabled - audioState exists: ${!!audioState}, muted: ${audioState?.muted}, volume: ${audioState?.volume}`);
      
      // Try to play anyway as fallback (since debug menu works)
      console.log('Attempting fallback sound play');
      if (typeof playUrlSoundWithFallback === 'function') {
        playUrlSoundWithFallback(urls);
      } else if (typeof playUrlSound === 'function') {
        playUrlSound(urls[0]);
      }
    }
  } catch(e) {
    console.log('Could not play milestone sound:', e);
  }

  setTimeout(() => {
    overlay.remove();
    milestonePopupShowing = false; // Resume QR scanning
  }, 3400);
}


// Volume panel toggle + outside click to close
(function(){
  const muteBtn = document.getElementById('muteBtn');
  const volumePanel = document.getElementById('volumePanel');
  if (!muteBtn || !volumePanel) return;
  let volTimer = null;
  function showVol(){ volumePanel.style.display='block'; volumePanel.style.opacity='1'; resetVolAuto(); }
  function hideVol(){ volumePanel.style.opacity='0'; setTimeout(()=>{ if (volumePanel.style.opacity==='0') volumePanel.style.display='none'; }, 500); }
  function resetVolAuto(){ clearTimeout(volTimer); volTimer = setTimeout(hideVol, 5000); }
  muteBtn.addEventListener('click', (e)=>{
    const hidden = (volumePanel.style.display==='none' || !volumePanel.style.display);
    if (hidden) showVol(); else hideVol();
    e.stopPropagation();
  });
  document.addEventListener('mousedown', (e)=>{
    if (volumePanel.style.display==='none') return;
    const t = e.target;
    if (t !== volumePanel && !volumePanel.contains(t) && t !== muteBtn) hideVol();
  });
  document.addEventListener('touchstart', (e)=>{
    if (volumePanel.style.display==='none') return;
    const t = e.target;
    if (t !== volumePanel && !volumePanel.contains(t) && t !== muteBtn) hideVol();
  }, {passive:true});
})();

</script>

<script>
(function(){
  const muteBtn = document.getElementById('muteBtn');
  const volumePanel = document.getElementById('volumePanel');
  const volumeSlider = document.getElementById('volumeSlider');
  /* DEBUG_BUTTON_WIRES */
  const dbg = {
    hide: document.getElementById('dbgHide'),
    c1: document.getElementById('dbgCorrect1'),
    wrong: document.getElementById('dbgWrong'),
    reset: document.getElementById('dbgReset'),
    c3: document.getElementById('dbgC3'),
    c5: document.getElementById('dbgC5'),
    c10: document.getElementById('dbgC10'),
  };

  function safeUpdate(ok){ try { if (typeof updateScore === 'function') updateScore(ok); } catch(e){ console.error(e); } }
  function clicks(n){
    (async ()=>{
      for (let i=0;i<n;i++){
        safeUpdate(true);
        await new Promise(r=>setTimeout(r, 120));
      }
    })();
  }
  function doReset(){
    try {
      if (typeof streak !== 'undefined') streak = 0;
      if (typeof score !== 'undefined') score = 0;
      if (typeof correctWords !== 'undefined' && correctWords && typeof correctWords.length === 'number') correctWords.length = 0;
      const scoreTagEl = document.getElementById('scoreTag');
      const streakTagEl = document.getElementById('streakTag');
      if (scoreTagEl) scoreTagEl.textContent = 'Score: ' + (typeof score!=='undefined'?score:0);
      if (streakTagEl) streakTagEl.textContent = 'Streak: ' + (typeof streak!=='undefined'?streak:0) + ' üî•';
      if (typeof updateStars === 'function') updateStars();
      if (typeof toast === 'function') toast('Debug: reset');
    } catch(e){ console.error(e); }
  }

  dbg.hide && dbg.hide.addEventListener('click', ()=>{ if (debugPanel) debugPanel.style.display='none'; });
  dbg.c1   && dbg.c1.addEventListener('click', ()=> clicks(1));
  dbg.wrong&& dbg.wrong.addEventListener('click', ()=> safeUpdate(false));
  dbg.reset&& dbg.reset.addEventListener('click', doReset);
  dbg.c3   && dbg.c3.addEventListener('click', ()=> clicks(3));
  dbg.c5   && dbg.c5.addEventListener('click', ()=> clicks(5));
  dbg.c10  && dbg.c10.addEventListener('click', ()=> clicks(10));

  const LS_MUTED = 'qr-word-game:muted';
  const LS_VOL = 'qr-word-game:volume';

  // defaults
  try {
    if (localStorage.getItem(LS_MUTED) === null) localStorage.setItem(LS_MUTED, 'false');
    if (localStorage.getItem(LS_VOL) === null) localStorage.setItem(LS_VOL, '0.7');
  } catch(e){}

  const state = {
    get muted(){ try { return (localStorage.getItem(LS_MUTED)||'true')==='true'; } catch(e){ return true; } },
    set muted(v){ try { localStorage.setItem(LS_MUTED, v?'true':'false'); } catch(e){} },
    get volume(){ try { return Math.max(0, Math.min(1, parseFloat(localStorage.getItem(LS_VOL)||'0')));} catch(e){ return 0; } },
    set volume(v){ try { localStorage.setItem(LS_VOL, String(Math.max(0, Math.min(1, v||0)))); } catch(e){} }
  };
  // expose
  window.__qr_audio_state__ = {
    get muted(){ return state.muted; },
    get volume(){ return state.volume; },
    setMuted(v){ state.muted = !!v; applyUI(); },
    setVolume(v){ state.volume = v; if (v>0) state.muted=false; applyUI(); }
  };

  function applyUI(){
    const vol = state.volume, muted = state.muted;
    if (muteBtn){
      if (muted || vol<=0) muteBtn.textContent='üîá';
      else if (vol<0.34) muteBtn.textContent='üîà';
      else if (vol<0.67) muteBtn.textContent='üîâ';
      else muteBtn.textContent='üîä';
    }
    if (volumeSlider) volumeSlider.value = String(vol);
  }
  applyUI();

  // panel show/hide with fade and auto-hide
  let t=null;
  function showPanel(){ if (!volumePanel) return; volumePanel.style.display='block'; volumePanel.style.opacity='1'; resetTimer(); }
  function hidePanel(){ if (!volumePanel) return; volumePanel.style.opacity='0'; setTimeout(()=>{ if (volumePanel.style.opacity==='0') volumePanel.style.display='none'; }, 500); }
  function resetTimer(){ clearTimeout(t); t = setTimeout(hidePanel, 5000); }

  if (muteBtn){
    muteBtn.addEventListener('click', ()=>{
      if (!volumePanel) return;
      const hidden = (volumePanel.style.display==='none' || !volumePanel.style.display);
      if (hidden) showPanel(); else hidePanel();
    });
  }
  if (volumeSlider){
    volumeSlider.addEventListener('input', (e)=>{
      resetTimer();
      const v = parseFloat(e.target.value||'0');
      window.__qr_audio_state__.setVolume(v);
    });
  }
  if (volumePanel){
    ['mousemove','mousedown','touchstart','touchmove','click'].forEach(ev=>volumePanel.addEventListener(ev, resetTimer, {passive:true}));
  }
  // Ensure muted default applied on first paint
  applyUI();
})();

/* LP_DEBUG_AND_AUDIO_BOOTSTRAP */
document.addEventListener('DOMContentLoaded', () => {
  const themeBtn = document.getElementById('themeBtn');
  const debugPanel = document.getElementById('debugPanel');
  const muteBtn = document.getElementById('muteBtn');
  const volumePanel = document.getElementById('volumePanel');
  const volumeSlider = document.getElementById('volumeSlider');
  /* DEBUG_BUTTON_WIRES */
  const dbg = {
    hide: document.getElementById('dbgHide'),
    c1: document.getElementById('dbgCorrect1'),
    wrong: document.getElementById('dbgWrong'),
    reset: document.getElementById('dbgReset'),
    c3: document.getElementById('dbgC3'),
    c5: document.getElementById('dbgC5'),
    c10: document.getElementById('dbgC10'),
  };

  function safeUpdate(ok){ try { if (typeof updateScore === 'function') updateScore(ok); } catch(e){ console.error(e); } }
  function clicks(n){
    (async ()=>{
      for (let i=0;i<n;i++){
        safeUpdate(true);
        await new Promise(r=>setTimeout(r, 120));
      }
    })();
  }
  function doReset(){
    try {
      if (typeof streak !== 'undefined') streak = 0;
      if (typeof score !== 'undefined') score = 0;
      if (typeof correctWords !== 'undefined' && correctWords && typeof correctWords.length === 'number') correctWords.length = 0;
      const scoreTagEl = document.getElementById('scoreTag');
      const streakTagEl = document.getElementById('streakTag');
      if (scoreTagEl) scoreTagEl.textContent = 'Score: ' + (typeof score!=='undefined'?score:0);
      if (streakTagEl) streakTagEl.textContent = 'Streak: ' + (typeof streak!=='undefined'?streak:0) + ' üî•';
      if (typeof updateStars === 'function') updateStars();
      if (typeof toast === 'function') toast('Debug: reset');
    } catch(e){ console.error(e); }
  }

  dbg.hide && dbg.hide.addEventListener('click', ()=>{ if (debugPanel) debugPanel.style.display='none'; });
  dbg.c1   && dbg.c1.addEventListener('click', ()=> clicks(1));
  dbg.wrong&& dbg.wrong.addEventListener('click', ()=> safeUpdate(false));
  dbg.reset&& dbg.reset.addEventListener('click', doReset);
  dbg.c3   && dbg.c3.addEventListener('click', ()=> clicks(3));
  dbg.c5   && dbg.c5.addEventListener('click', ()=> clicks(5));
  dbg.c10  && dbg.c10.addEventListener('click', ()=> clicks(10));


  // Always hide debug on load
  if (debugPanel) debugPanel.style.display = 'none';

  // ---- Long-press (4s) to reveal debug with click-guard
  let lpTimer = null;
  let lpFired = false;

  function revealDebug() {
    lpFired = true;
    if (debugPanel) debugPanel.style.display = 'block';
    try { toast && toast('Debug menu unlocked'); } catch(e) { }
  }
  function lpStart() { clearTimeout(lpTimer); lpTimer = setTimeout(revealDebug, 4000); }
  function lpEnd()   { clearTimeout(lpTimer); lpTimer = null; }

  if (themeBtn) {
    // Click guard in capture phase prevents theme toggle after long-press
    themeBtn.addEventListener('click', (e) => {
      if (lpFired) { lpFired = false; e.preventDefault(); e.stopImmediatePropagation(); }
    }, true);

    if (window.PointerEvent) {
      themeBtn.addEventListener('pointerdown', lpStart);
      themeBtn.addEventListener('pointerup', lpEnd);
      themeBtn.addEventListener('pointerleave', lpEnd);
      themeBtn.addEventListener('pointercancel', lpEnd);
    } else {
      themeBtn.addEventListener('mousedown', lpStart);
      themeBtn.addEventListener('mouseup', lpEnd);
      themeBtn.addEventListener('mouseleave', lpEnd);
      themeBtn.addEventListener('touchstart', lpStart, { passive: true });
      themeBtn.addEventListener('touchend', lpEnd);
      themeBtn.addEventListener('touchcancel', lpEnd);
    }
  }

  // ---- Volume panel show/hide (fade-out + outside click closes)
  let volTimer = null;
  function showVol() { if (!volumePanel) return; volumePanel.style.display='block'; volumePanel.style.opacity='1'; resetVolAuto(); }
  function hideVol() { if (!volumePanel) return; volumePanel.style.opacity='0'; setTimeout(()=>{ if (volumePanel.style.opacity==='0') volumePanel.style.display='none'; }, 500); }
  function resetVolAuto() { clearTimeout(volTimer); volTimer = setTimeout(hideVol, 5000); }

  if (muteBtn) {
    muteBtn.addEventListener('click', (e)=>{
      if (!volumePanel) return;
      const hidden = (volumePanel.style.display==='none' || !volumePanel.style.display);
      if (hidden) showVol(); else hideVol();
      e.stopPropagation(); // prevent outside-click handler from immediately hiding it
    });
  }
  if (volumeSlider) {
    volumeSlider.addEventListener('input', (e)=>{ resetVolAuto(); });
  }

  // Close volume panel when clicking/touching anywhere outside it (and not the mute button)
  document.addEventListener('mousedown', (e)=>{
    if (!volumePanel || volumePanel.style.display==='none') return;
    const t = e.target;
    if (t !== volumePanel && !volumePanel.contains(t) && t !== muteBtn) hideVol();
  });
  document.addEventListener('touchstart', (e)=>{
    if (!volumePanel || volumePanel.style.display==='none') return;
    const t = e.target;
    if (t !== volumePanel && !volumePanel.contains(t) && t !== muteBtn) hideVol();
  }, {passive:true});
});


function showMilestoneOverlay(stars) {
  milestonePopupShowing = true; // Pause QR scanning
  
  const name = (document.getElementById('studentName')?.value || localStorage.getItem('qr-word-game:student-name') || '').trim();
  const shout = (stars === 20) ? 'YOU WIN!' : (name ? ('KEEP GOING, ' + name.toUpperCase() + '!') : 'KEEP GOING!');

  const overlay = document.createElement('div');
  Object.assign(overlay.style, { position:'fixed', inset:'0', background:'rgba(0,0,0,.55)', display:'flex',
    alignItems:'center', justifyContent:'center', zIndex:'10001' });

  const card = document.createElement('div');
  Object.assign(card.style, { background:'#1e3a5f', color:'#d1e9ff', borderRadius:'18px', padding:'24px 20px',
    width:'min(92%, 780px)', boxShadow:'0 20px 70px rgba(0,0,0,.6)', border:'6px solid #e2e8f0',
    textAlign:'center', overflow:'hidden', boxSizing:'border-box' });

  function makeRow(cnt){
    const row = document.createElement('div');
    Object.assign(row.style, { display:'grid', gridTemplateColumns:'repeat(10, 1fr)', gap:'6px', alignItems:'center' });
    for (let i=0;i<cnt;i++){ const s=document.createElement('span'); s.textContent='‚≠ê'; s.style.display='block'; s.style.textAlign='center'; row.appendChild(s); }
    return row;
  }
  const row1 = makeRow(Math.min(stars, 10));
  const row2 = stars>10 ? makeRow(stars-10) : null;
  const starsWrap = document.createElement('div');
  Object.assign(starsWrap.style, { display:'flex', flexDirection:'column', gap:'8px', marginBottom:'8px' });
  starsWrap.appendChild(row1); if (row2) starsWrap.appendChild(row2);

  const titleEl = document.createElement('div');
  Object.assign(titleEl.style, { fontSize:'72px', fontWeight:'800', letterSpacing:'1px', margin:'6px 0' });
  titleEl.textContent = String(stars) + ' STARS!';

  const msgEl = document.createElement('div');
  Object.assign(msgEl.style, { fontSize:'28px', fontWeight:'700', opacity:'.9', marginTop:'6px' });
  msgEl.textContent = shout;

  card.appendChild(starsWrap);
  card.appendChild(titleEl);
  card.appendChild(msgEl);

  if (stars === 20) {
    const img = document.createElement('img');
    img.src = 'https://raw.githubusercontent.com/zwickarr/QR-Teach/main/images/youwin.png';
    img.alt = 'You Win';
    img.style.maxWidth = '220px';
    img.style.marginTop = '12px';
    img.style.borderRadius = '14px';
    card.appendChild(img);
  }

  overlay.appendChild(card);
  document.body.appendChild(overlay);

  const fit = () => {
    const gap = 6, inner = card.clientWidth - 40;
    const per = Math.floor((inner - gap*9) / 10);
    const size = Math.max(18, Math.min(48, per));
    [row1, row2].forEach(r => r && r.querySelectorAll('span').forEach(el => { el.style.fontSize = size+'px'; el.style.lineHeight='1'; }));
  };
  fit(); window.addEventListener('resize', fit, { once:true });

  try {
    // Try multiple formats for better browser compatibility
    const urls = stars === 20 
      ? [
          './sfx/Victory.flac',
          'https://raw.githubusercontent.com/zwickarr/QR-Teach/main/sfx/Victory.flac',
          'https://github.com/zwickarr/QR-Teach/raw/main/sfx/Victory.flac'
        ]
      : [
          './sfx/TadaFanfare.flac', 
          'https://raw.githubusercontent.com/zwickarr/QR-Teach/main/sfx/TadaFanfare.flac',
          'https://github.com/zwickarr/QR-Teach/raw/main/sfx/TadaFanfare.flac'
        ];
    
    console.log(`Milestone ${stars}: Attempting to play sound`);
    
    // Ensure audio state exists and is not muted
    const audioState = window.__qr_audio_state__;
    console.log('Audio state:', audioState);
    
    if (audioState && !audioState.muted && audioState.volume > 0) {
      console.log(`Audio enabled - muted: ${audioState.muted}, volume: ${audioState.volume}`);
      if (typeof playUrlSoundWithFallback === 'function') {
        console.log('Using playUrlSoundWithFallback');
        playUrlSoundWithFallback(urls);
      } else if (typeof playUrlSound === 'function') {
        console.log('Using playUrlSound fallback');
        playUrlSound(urls[0]);
      } else {
        console.log('No sound functions available');
      }
    } else {
      console.log(`Audio disabled - audioState exists: ${!!audioState}, muted: ${audioState?.muted}, volume: ${audioState?.volume}`);
      
      // Try to play anyway as fallback (since debug menu works)
      console.log('Attempting fallback sound play');
      if (typeof playUrlSoundWithFallback === 'function') {
        playUrlSoundWithFallback(urls);
      } else if (typeof playUrlSound === 'function') {
        playUrlSound(urls[0]);
      }
    }
  } catch(e) {
    console.log('Could not play milestone sound:', e);
  }

  setTimeout(() => {
    overlay.remove();
    milestonePopupShowing = false; // Resume QR scanning
  }, 3400);
}


// Volume panel toggle + outside click to close
(function(){
  const muteBtn = document.getElementById('muteBtn');
  const volumePanel = document.getElementById('volumePanel');
  if (!muteBtn || !volumePanel) return;
  let volTimer = null;
  function showVol(){ volumePanel.style.display='block'; volumePanel.style.opacity='1'; resetVolAuto(); }
  function hideVol(){ volumePanel.style.opacity='0'; setTimeout(()=>{ if (volumePanel.style.opacity==='0') volumePanel.style.display='none'; }, 500); }
  function resetVolAuto(){ clearTimeout(volTimer); volTimer = setTimeout(hideVol, 5000); }
  muteBtn.addEventListener('click', (e)=>{
    const hidden = (volumePanel.style.display==='none' || !volumePanel.style.display);
    if (hidden) showVol(); else hideVol();
    e.stopPropagation();
  });
  document.addEventListener('mousedown', (e)=>{
    if (volumePanel.style.display==='none') return;
    const t = e.target;
    if (t !== volumePanel && !volumePanel.contains(t) && t !== muteBtn) hideVol();
  });
  document.addEventListener('touchstart', (e)=>{
    if (volumePanel.style.display==='none') return;
    const t = e.target;
    if (t !== volumePanel && !volumePanel.contains(t) && t !== muteBtn) hideVol();
  }, {passive:true});
})();

</script>


<script>
/*VOL_TOGGLE_OUTSIDE*/
(function(){
  const muteBtn = document.getElementById('muteBtn');
  const volumePanel = document.getElementById('volumePanel');
  const volumeSlider = document.getElementById('volumeSlider');
  if (!muteBtn || !volumePanel) return;
  let volTimer = null;
  function showVol(){ volumePanel.style.display='block'; volumePanel.style.opacity='1'; resetVolAuto(); }
  function hideVol(){ volumePanel.style.opacity='0'; setTimeout(()=>{ if (volumePanel.style.opacity==='0') volumePanel.style.display='none'; }, 500); }
  function resetVolAuto(){ clearTimeout(volTimer); volTimer = setTimeout(hideVol, 5000); }
  muteBtn.addEventListener('click', (e)=>{
    const hidden = (volumePanel.style.display==='none' || !volumePanel.style.display);
    if (hidden) showVol(); else hideVol();
    e.stopPropagation();
  });
  if (volumeSlider) volumeSlider.addEventListener('input', resetVolAuto);
  document.addEventListener('mousedown', (e)=>{
    if (volumePanel.style.display==='none') return;
    const t = e.target;
    if (t !== volumePanel && !volumePanel.contains(t) && t !== muteBtn) hideVol();
  });
  document.addEventListener('touchstart', (e)=>{
    if (volumePanel.style.display==='none') return;
    const t = e.target;
    if (t !== volumePanel && !volumePanel.contains(t) && t !== muteBtn) hideVol();
  }, {passive:true});
})();
</script>

</body>
</html>