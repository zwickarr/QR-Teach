<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1" />
	<title>QR Word Match</title>
	<meta name="color-scheme" content="dark light">
	<style>
		:root { --bg:#0b0d12; --fg:#f7f7f7; --muted:#a8b0bd; --ok:#1cc88a; --bad:#ff5d5d; }
		* { box-sizing: border-box; }
		body { margin: 0; padding: 0; background: var(--bg); color: var(--fg);
			font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
			display: grid; min-height: 100vh; grid-template-rows: auto 1fr auto; }
		header, footer { padding: 12px 16px; background: #0f131a; border-bottom: 1px solid #151a22; }
		header h1 { margin: 0; font-size: 18px; letter-spacing: .4px; }
		main { padding: 14px; display: grid; gap: 12px; align-content: start; }
		.card { background: #111722; border: 1px solid #1c2432; border-radius: 14px; padding: 12px; display: grid; gap: 10px; }
		button, select { background: #1a2230; color: var(--fg); border: 1px solid #2a3548; border-radius: 10px;
			padding: 10px 14px; font-size: 16px; cursor: pointer; }
		button:active { transform: translateY(1px); }
		button:disabled { opacity: 0.5; cursor: not-allowed; }
		.word { font-size: clamp(28px, 7vw, 60px); text-align: center; font-weight: 800; letter-spacing: .8px;
			padding: 12px 10px; border-radius: 12px; background: #0f1520; border: 1px dashed #25324a; }
		.status { text-align: center; font-weight: 700; min-height: 1.2em; }
		.status.ok { color: var(--ok); } .status.bad { color: var(--bad); }
		#reader { width: 100%; max-width: 560px; margin: 0 auto; border-radius: 12px; overflow: hidden;
			border: 1px solid #283449; background: #0a0f16; position: relative; min-height: 200px; }
		.small { color: var(--muted); font-size: 12px; }
		.row { display: flex; gap: 8px; flex-wrap: wrap; align-items:center; }
		.tag { font-size: 12px; color: var(--muted); background:#0d1420; border:1px solid #1f2a3d; padding:6px 8px; border-radius:999px;}
		.selects { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
		.toggle { display:flex; gap:6px; background:#0d1420; border:1px solid #1f2a3d; padding:6px; border-radius:999px; }
		.toggle label { padding:6px 10px; border-radius:999px; cursor:pointer; user-select:none; }
		.toggle input { display:none; }
		.toggle input:checked + span { background:#1a2230; border:1px solid #2a3548; }
		#refreshCams { padding-inline: 10px; }
		#reader video { width:100% !important; }
		.loading { padding: 20px; text-align: center; color: var(--muted); }
	</style>
</head>
<body>
	<header><h1>QR Word Match</h1></header>
	<main>
		<div class="card">
			<div class="row" style="justify-content:space-between;">
				<div class="row">
					<button id="startBtn" disabled>Start camera</button>
					<button id="stopBtn" disabled>Stop</button>
					<button id="nextBtn">New word</button>
				</div>
				<div class="selects">
					<select id="cameraSel" title="Choose camera">
						<option value="">(choose camera)</option>
					</select>
					<button id="refreshCams" type="button" title="Refresh camera list">â†»</button>
					<div class="toggle" title="Force front/back camera">
						<label><input type="radio" name="face" value="environment" checked><span>Back</span></label>
						<label><input type="radio" name="face" value="user"><span>Front</span></label>
					</div>
					<select id="mode">
						<option value="exact" selected>Exact match</option>
						<option value="loose">Ignore accents & case</option>
					</select>
				</div>
			</div>
			<div id="currentWord" class="word" aria-live="polite">gato</div>
			<div class="status" id="status"></div>
			<div id="reader">
				<div class="loading" id="loadingMsg">Loading QR scanner...</div>
			</div>
			<div class="row">
				<div class="tag" id="scoreTag">Score: 0</div>
				<div class="tag" id="streakTag">Streak: 0 ðŸ”¥</div>
				<div class="tag" id="camInfo">Cameras: ?</div>
			</div>
			<div id="err" class="small" style="color:#ff8c8c;"></div>
			<details style="margin-top: 8px;">
				<summary style="cursor: pointer; color: var(--muted); font-size: 12px;">ðŸ“· Camera troubleshooting</summary>
				<div style="padding: 10px; font-size: 12px; color: var(--muted); line-height: 1.5;">
					<strong>If camera won't start:</strong><br>
					â€¢ First time? Click "Allow" when browser asks for camera permission<br>
					â€¢ Blocked before? Click lock icon in address bar â†’ Camera â†’ Allow â†’ Refresh<br>
					â€¢ On iPhone? Use Safari (Chrome on iOS doesn't support cameras well)<br>
					â€¢ On Android? Try Chrome or Edge<br>
					â€¢ Still stuck? Try: Settings â†’ Site Settings â†’ Camera â†’ Allow this site<br>
					â€¢ Using private/incognito mode? Camera might be blocked by default
				</div>
			</details>
			<p class="small">If the dropdown is empty on iOS, use the Front/Back toggle. After you allow the camera once, press â†» to populate real camera names.</p>
		</div>

		<div class="card">
			<strong>Word list</strong>
			<p class="small">Edit below to customize. One word per line.</p>
			<textarea id="wordList" rows="6" style="width:100%; background:#0f1520; color:var(--fg); border:1px solid #25324a; border-radius:10px; padding:10px; font-size:15px;">gato
ratÃ³n
castillo
elefante
perro
tres</textarea>
			<div class="row">
				<button id="saveWords">Save list</button>
				<span class="small">Saved to your browser.</span>
			</div>
		</div>
	</main>
	<footer><span class="small">Use over HTTPS for camera access.</span></footer>

	<script>
	// Dynamic script loader with fallback
	function loadScript(src, fallbackSrc) {
		return new Promise((resolve, reject) => {
			const script = document.createElement('script');
			script.src = src;
			script.onload = resolve;
			script.onerror = () => {
				if (fallbackSrc) {
					const fallback = document.createElement('script');
					fallback.src = fallbackSrc;
					fallback.onload = resolve;
					fallback.onerror = reject;
					document.head.appendChild(fallback);
				} else {
					reject(new Error('Failed to load script'));
				}
			};
			document.head.appendChild(script);
		});
	}

	// Load libraries
	async function loadLibraries() {
		try {
			// Try loading html5-qrcode with fallback
			await loadScript(
				'https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js',
				'https://cdn.jsdelivr.net/npm/html5-qrcode@2.3.8/html5-qrcode.min.js'
			);
			
			// Load confetti (optional, so we don't fail if it doesn't load)
			loadScript('https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js').catch(() => {
				console.warn('Confetti library failed to load');
			});

			// Check if Html5Qrcode is available
			if (typeof Html5Qrcode === 'undefined') {
				throw new Error('Html5Qrcode not defined after loading');
			}

			// Initialize the app
			initApp();
		} catch (error) {
			document.getElementById('err').textContent = 'Failed to load QR scanner library. Please refresh the page.';
			document.getElementById('loadingMsg').textContent = 'Failed to load scanner';
			console.error('Library loading error:', error);
		}
	}

	function initApp() {
		// Hide loading message
		document.getElementById('loadingMsg').style.display = 'none';
		
		// Shared UI
		const wordEl = document.getElementById('currentWord');
		const statusEl = document.getElementById('status');
		const startBtn = document.getElementById('startBtn');
		const stopBtn = document.getElementById('stopBtn');
		const nextBtn = document.getElementById('nextBtn');
		const modeSel = document.getElementById('mode');
		const wordListTA = document.getElementById('wordList');
		const saveWordsBtn = document.getElementById('saveWords');
		const scoreTag = document.getElementById('scoreTag');
		const streakTag = document.getElementById('streakTag');
		const cameraSel = document.getElementById('cameraSel');
		const refreshBtn = document.getElementById('refreshCams');
		const faceRadios = document.querySelectorAll('input[name="face"]');
		const camInfo = document.getElementById('camInfo');
		const errEl = document.getElementById('err');

		// Enable start button
		startBtn.disabled = false;

		const LS_KEY = "qr-word-game:list";
		const LS_CAM = "qr-word-game:camera-id";
		const LS_FACE = "qr-word-game:facing";
		let html5QrCode = null;
		let scanning = false;
		let score = 0, streak = 0;
		let lastText = null;

		function loadWords(){
			const saved = localStorage.getItem(LS_KEY);
			if(saved) wordListTA.value = saved;
			return wordListTA.value.split(/[\r\n]+/).map(s=>s.trim()).filter(Boolean);
		}
		
		function saveWords(){
			localStorage.setItem(LS_KEY, wordListTA.value);
			words = loadWords();
			toast("Saved!");
		}
		saveWordsBtn.addEventListener('click', saveWords);

		let words = loadWords();
		function randomWord(){ 
			if(words.length===0){words=["gato"];} 
			return words[Math.floor(Math.random()*words.length)]; 
		}
		
		function setWord(w){ 
			wordEl.textContent=w; 
			statusEl.textContent=""; 
			statusEl.className="status"; 
		}
		setWord(randomWord());

		function normalize(s){
			if(modeSel.value==="exact") return s.trim();
			return s.normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase().trim();
		}
		
		function celebrate(){
			if (typeof confetti === 'function') {
				confetti({ particleCount: 90, spread: 65, origin: { y: 0.6 } });
				confetti({ particleCount: 60, angle: 120, spread: 55, origin: { y: 0.6, x: 0.2 } });
				confetti({ particleCount: 60, angle: 60, spread: 55, origin: { y: 0.6, x: 0.8 } });
			}
		}
		
		function updateScore(ok){
			if(ok){ 
				score += 1; 
				streak += 1; 
			} else { 
				streak = 0; 
			}
			scoreTag.textContent = "Score: " + score;
			streakTag.textContent = "Streak: " + streak + " ðŸ”¥";
		}
		
		function toast(msg){
			const el = document.createElement('div');
			el.textContent = msg;
			el.style.cssText = "position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#111722;border:1px solid #1c2432;padding:8px 12px;border-radius:999px;color:var(--fg);box-shadow:0 8px 30px rgba(0,0,0,.4);z-index:9999";
			document.body.appendChild(el);
			setTimeout(()=> el.remove(), 1200);
		}

		function getFacing(){
			const saved = localStorage.getItem(LS_FACE);
			if (saved) { 
				for (const r of faceRadios) {
					if (r.value===saved) r.checked=true;
				}
			}
			const r = Array.from(faceRadios).find(r=>r.checked); 
			return r? r.value : "environment";
		}
		
		faceRadios.forEach(r=> r.addEventListener('change', async () => {
			localStorage.setItem(LS_FACE, getFacing());
			if (scanning) { 
				await stop(); 
				await start(); 
			}
		}));

		async function enumerateCameras(){
			try{
				if (typeof Html5Qrcode === 'undefined') {
					errEl.textContent = "QR library not loaded";
					return;
				}
				
				const cams = await Html5Qrcode.getCameras();
				cameraSel.innerHTML = '<option value="">(choose camera)</option>';
				for (const c of cams) {
					const opt = document.createElement("option");
					opt.value = c.id;
					opt.textContent = c.label || "Camera";
					cameraSel.appendChild(opt);
				}
				camInfo.textContent = "Cameras: " + cams.length;
				
				// prefer saved
				const saved = localStorage.getItem(LS_CAM);
				if (saved && [...cameraSel.options].some(o => o.value === saved)) {
					cameraSel.value = saved;
				} else {
					const back = cams.find(c => /\b(back|rear|environment)\b/i.test(c.label||""));
					if (back) cameraSel.value = back.id;
				}
				if (!cameraSel.value && cams[0]) cameraSel.value = cams[0].id;
			}catch(e){
				errEl.textContent = "enumerate error: " + (e.message||e);
			}
		}
		refreshBtn.addEventListener('click', enumerateCameras);

		function onScan(decodedText){
			if(decodedText === lastText) return;
			lastText = decodedText;
			const ok = normalize(decodedText) === normalize(wordEl.textContent);
			updateScore(ok);
			if (ok){
				statusEl.textContent = "âœ“ Correct: " + decodedText;
				statusEl.className = "status ok";
				celebrate();
				setTimeout(()=> setWord(randomWord()), 900);
			}else{
				statusEl.textContent = "âœ– Not matched: " + decodedText;
				statusEl.className = "status bad";
			}
		}
		
		function onScanError(err){ 
			// Ignore continuous scan errors
		}

		async function start(){
			if (scanning) return;
			try{
				errEl.textContent = ""; // Clear previous errors
				
				if (typeof Html5Qrcode === 'undefined') {
					throw new Error('QR scanner library not loaded');
				}
				
				const w = document.getElementById('reader').clientWidth || 320;
				html5QrCode = new Html5Qrcode("reader", { verbose: false });

				// ensure we have at least facingMode fallback
				if (!cameraSel.options.length || cameraSel.options.length === 1) { 
					await enumerateCameras(); 
				}

				let config;
				const selected = cameraSel.value;
				if (selected) {
					config = { deviceId: { exact: selected } };
				} else {
					config = { facingMode: getFacing() };
				}

				await html5QrCode.start(
					config,
					{ 
						fps: 10, 
						qrbox: { width: Math.min(280, w-20), height: Math.min(280, w-20) }, 
						aspectRatio: 1.0
					},
					onScan,
					onScanError
				);

				if (selected) localStorage.setItem(LS_CAM, selected);
				localStorage.setItem(LS_FACE, getFacing());

				scanning = true;
				startBtn.disabled = true; 
				stopBtn.disabled = false; 
				nextBtn.disabled = true;

				// after permission, refresh labels
				setTimeout(enumerateCameras, 300);
			}catch(e){
				errEl.textContent = "start error: " + (e.message || e);
				scanning = false;
				startBtn.disabled = false;
				stopBtn.disabled = true;
			}
		}

		async function stop(){
			if (!scanning) return;
			try { 
				if (html5QrCode) {
					await html5QrCode.stop(); 
					await html5QrCode.clear();
				}
			} catch(e) {
				console.error("Stop error:", e);
			}
			scanning = false;
			startBtn.disabled = false; 
			stopBtn.disabled = true; 
			nextBtn.disabled = false;
			lastText = null; // Reset last scanned text
		}

		startBtn.addEventListener('click', start);
		stopBtn.addEventListener('click', stop);
		nextBtn.addEventListener('click', ()=> setWord(randomWord()));
		cameraSel.addEventListener('change', async () => {
			localStorage.setItem(LS_CAM, cameraSel.value);
			if (scanning) { 
				await stop(); 
				await start(); 
			}
		});

		// Error surfacing
		window.addEventListener('error', e => {
			const msg = e.error?.message || e.message || e.filename || 'Unknown error';
			errEl.textContent = 'Error: ' + msg;
		});
		window.addEventListener('unhandledrejection', e => {
			const msg = e.reason?.message || e.reason || 'Promise rejected';
			errEl.textContent = 'Promise error: ' + msg;
		});

		// Init
		setWord(randomWord());
		getFacing();
		enumerateCameras();
	}

	// Start loading libraries when page loads
	loadLibraries();
	</script>
</body>
</html>