<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
	<title>QR Word Match</title>
	<meta name="color-scheme" content="dark light">
	<style>
		:root { --bg:#0b0d12; --fg:#f7f7f7; --muted:#a8b0bd; --ok:#1cc88a; --bad:#ff5d5d; }
		* { box-sizing: border-box; }
		body { margin: 0; padding: 0; background: var(--bg); color: var(--fg);
			font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
			display: grid; min-height: 100vh; grid-template-rows: auto 1fr auto; }
		header, footer { padding: 12px 16px; background: #0f131a; border-bottom: 1px solid #151a22; }
		header h1 { margin: 0; font-size: 18px; letter-spacing: .4px; }
		main { padding: 14px; display: grid; gap: 12px; align-content: start; }
		.card { background: #111722; border: 1px solid #1c2432; border-radius: 14px; padding: 12px; display: grid; gap: 10px; }
		button, select { background: #1a2230; color: var(--fg); border: 1px solid #2a3548; border-radius: 10px;
			padding: 10px 14px; font-size: 16px; cursor: pointer; }
		button:active { transform: translateY(1px); }
		button:disabled { opacity: 0.5; cursor: not-allowed; }
		.word { font-size: clamp(28px, 7vw, 60px); text-align: center; font-weight: 800; letter-spacing: .8px;
			padding: 12px 10px; border-radius: 12px; background: #0f1520; border: 1px dashed #25324a; }
		.status { text-align: center; font-weight: 700; min-height: 1.2em; }
		.status.ok { color: var(--ok); } .status.bad { color: var(--bad); }
		
		/* Video container styles */
		#videoContainer { 
			width: 100%; 
			max-width: 560px; 
			margin: 0 auto; 
			border-radius: 12px; 
			overflow: hidden;
			border: 1px solid #283449; 
			background: #0a0f16; 
			position: relative;
			aspect-ratio: 4/3;
		}
		#video { 
			width: 100%;
			height: 100%;
			object-fit: cover;
			display: block;
		}
		#canvas {
			display: none;
		}
		.scan-region {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			width: 250px;
			height: 250px;
			border: 2px solid rgba(28, 200, 138, 0.6);
			border-radius: 12px;
			box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
		}
		.scan-line {
			position: absolute;
			width: 100%;
			height: 2px;
			background: linear-gradient(90deg, transparent, #1cc88a, transparent);
			animation: scan 2s linear infinite;
		}
		@keyframes scan {
			0% { top: 0; }
			100% { top: calc(100% - 2px); }
		}
		@keyframes pulse {
			0%, 100% { transform: scale(1); }
			50% { transform: scale(1.2); }
		}
		@keyframes bigNumber {
			0% { transform: scale(0) rotate(0deg); opacity: 0; }
			50% { transform: scale(1.5) rotate(180deg); opacity: 1; }
			100% { transform: scale(1) rotate(360deg); opacity: 1; }
		}
		
		#stars { 
			text-align: center; 
			font-size: 28px; 
			min-height: 35px;
			animation-duration: 0.5s;
			animation-timing-function: ease-in-out;
		}
		#pictogram {
			text-align: center;
			margin: 10px 0;
			min-height: 150px;
			display: none;
		}
		#muteBtn {
			font-size: 20px;
			padding: 8px 12px;
			background: #1a2230;
			min-width: 50px;
		}
		#bigMilestone {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			font-size: 150px;
			font-weight: bold;
			color: #1cc88a;
			text-shadow: 0 0 30px rgba(28, 200, 138, 0.8);
			animation: bigNumber 1s ease-out;
			pointer-events: none;
			z-index: 10000;
		}
		
		.small { color: var(--muted); font-size: 12px; }
		.row { display: flex; gap: 8px; flex-wrap: wrap; align-items:center; }
		.tag { font-size: 12px; color: var(--muted); background:#0d1420; border:1px solid #1f2a3d; padding:6px 8px; border-radius:999px;}
		.selects { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
		.toggle { display:flex; gap:6px; background:#0d1420; border:1px solid #1f2a3d; padding:6px; border-radius:999px; }
		.toggle label { padding:6px 10px; border-radius:999px; cursor:pointer; user-select:none; }
		.toggle input { display:none; }
		.toggle input:checked + span { background:#1a2230; border:1px solid #2a3548; }
		.loading { padding: 20px; text-align: center; color: var(--muted); }
		details summary { cursor: pointer; user-select: none; }
		details summary:hover { color: var(--fg); }
	</style>
</head>
<body>
	<header><h1>QR Word Match</h1></header>
	<main>
		<div class="card">
			<div class="row" style="justify-content:space-between;">
				<div class="row">
					<button id="startBtn">Start camera</button>
					<button id="stopBtn" disabled>Stop</button>
					<button id="nextBtn">New word</button>
					<button id="muteBtn" title="Toggle sound">üîä</button>
				</div>
				<div class="selects">
					<select id="mode">
						<option value="exact" selected>Exact match</option>
						<option value="loose">Ignore accents & case</option>
					</select>
					<div class="toggle" title="Display mode">
						<label><input type="radio" name="display" value="word" checked><span>Word</span></label>
						<label><input type="radio" name="display" value="pictogram"><span>Pictogram</span></label>
					</div>
				</div>
			</div>
			<div id="currentWord" class="word" aria-live="polite">gato</div>
			<div id="pictogram"></div>
			<div id="stars"></div>
			<div class="status" id="status"></div>
			
			<div id="videoContainer" style="display:none;">
				<video id="video" playsinline></video>
				<div class="scan-region">
					<div class="scan-line"></div>
				</div>
			</div>
			<canvas id="canvas"></canvas>
			
			<div class="row">
				<div class="tag" id="scoreTag">Score: 0</div>
				<div class="tag" id="streakTag">Streak: 0 üî•</div>
			</div>
			<div id="err" class="small" style="color:#ff8c8c;"></div>
			<details style="margin-top: 8px;">
				<summary style="cursor: pointer; color: var(--muted); font-size: 12px;">üì∑ Camera troubleshooting</summary>
				<div style="padding: 10px; font-size: 12px; color: var(--muted); line-height: 1.5;">
					<strong>If camera won't start:</strong><br>
					‚Ä¢ First time? Click "Allow" when browser asks for camera permission<br>
					‚Ä¢ Blocked before? Click lock icon in address bar ‚Üí Camera ‚Üí Allow ‚Üí Refresh<br>
					‚Ä¢ On iPhone? Use Safari (Chrome on iOS doesn't support cameras well)<br>
					‚Ä¢ Camera stuck? Try Stop then Start again<br>
					‚Ä¢ Still stuck? Refresh the page
				</div>
			</details>
		</div>

		<div class="card">
			<details open>
				<summary style="font-weight: bold; margin-bottom: 8px;">Word list</summary>
				<p class="small">Edit below to customize. One word per line. Duplicates are automatically removed (case-insensitive).</p>
				<textarea id="wordList" rows="6" style="width:100%; background:#0f1520; color:var(--fg); border:1px solid #25324a; border-radius:10px; padding:10px; font-size:15px;">gato
rat√≥n
castillo
elefante
perro
tres</textarea>
				<div class="row" style="margin-top: 10px;">
					<button id="saveWords">Save list</button>
					<button id="downloadWords">Download list</button>
					<button id="uploadBtn">Load from file</button>
					<input type="file" id="fileInput" accept=".txt" style="display:none;">
				</div>
			</details>
			<details style="margin-top: 8px;">
				<summary style="cursor: pointer; color: var(--muted); font-size: 12px;">üìÅ File handling tips</summary>
				<div style="padding: 10px; font-size: 12px; color: var(--muted); line-height: 1.5;">
					<strong>iPhone/iPad:</strong><br>
					‚Ä¢ Downloads go to Files app ‚Üí Downloads folder<br>
					‚Ä¢ In Safari: Tap download icon in address bar<br>
					‚Ä¢ To load: Tap "Load from file" ‚Üí Browse ‚Üí Downloads<br><br>
					<strong>Android:</strong><br>
					‚Ä¢ Downloads go to Downloads folder<br>
					‚Ä¢ Check notification or Downloads app<br><br>
					<strong>Sharing tip:</strong><br>
					‚Ä¢ Teachers can share word lists via email/AirDrop<br>
					‚Ä¢ Students save the .txt file and load it here
				</div>
			</details>
		</div>
	</main>
	<footer><span class="small">Use over HTTPS for camera access. Using back camera with sound & pictograms.</span></footer>

	<!-- Load confetti for celebrations -->
	<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
	<!-- Load jsQR as fallback QR reader -->
	<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

	<script>
	// UI Elements
	const wordEl = document.getElementById('currentWord');
	const statusEl = document.getElementById('status');
	const startBtn = document.getElementById('startBtn');
	const stopBtn = document.getElementById('stopBtn');
	const nextBtn = document.getElementById('nextBtn');
	const muteBtn = document.getElementById('muteBtn');
	const modeSel = document.getElementById('mode');
	const wordListTA = document.getElementById('wordList');
	const saveWordsBtn = document.getElementById('saveWords');
	const downloadWordsBtn = document.getElementById('downloadWords');
	const uploadBtn = document.getElementById('uploadBtn');
	const fileInput = document.getElementById('fileInput');
	const scoreTag = document.getElementById('scoreTag');
	const streakTag = document.getElementById('streakTag');
	const displayRadios = document.querySelectorAll('input[name="display"]');
	const errEl = document.getElementById('err');
	const video = document.getElementById('video');
	const canvas = document.getElementById('canvas');
	const ctx = canvas.getContext('2d');
	const videoContainer = document.getElementById('videoContainer');
	const starsEl = document.getElementById('stars');
	const pictogramEl = document.getElementById('pictogram');

	// State
	const LS_KEY = "qr-word-game:list";
	const LS_MUTED = "qr-word-game:muted";
	const LS_DISPLAY = "qr-word-game:display";
	let stream = null;
	let scanning = false;
	let score = 0, streak = 0;
	let lastText = null;
	let scanInterval = null;
	let barcodeDetector = null;
	let isMuted = localStorage.getItem(LS_MUTED) === 'true';
	let audioContext = null;
	let correctWords = [];
	let displayMode = localStorage.getItem(LS_DISPLAY) || 'word';
	
	// Initialize display mode
	for (const r of displayRadios) {
		if (r.value === displayMode) r.checked = true;
	}
	
	// Initialize mute button
	muteBtn.textContent = isMuted ? 'üîá' : 'üîä';
	
	// Sound generation
	function initAudio() {
		if (!audioContext) {
			audioContext = new (window.AudioContext || window.webkitAudioContext)();
		}
	}
	
	function playSound(frequency, duration, type = 'sine') {
		if (isMuted) return;
		
		try {
			initAudio();
			const oscillator = audioContext.createOscillator();
			const gainNode = audioContext.createGain();
			
			oscillator.connect(gainNode);
			gainNode.connect(audioContext.destination);
			
			oscillator.type = type;
			oscillator.frequency.value = frequency;
			
			gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
			gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
			
			oscillator.start(audioContext.currentTime);
			oscillator.stop(audioContext.currentTime + duration);
		} catch(e) {
			console.log('Audio not available');
		}
	}
	
	function playCorrectSound() {
		// Pleasant ascending tones
		setTimeout(() => playSound(523, 0.1), 0);    // C
		setTimeout(() => playSound(659, 0.1), 100);  // E
		setTimeout(() => playSound(784, 0.2), 200);  // G
	}
	
	function playMilestoneSound() {
		// Fanfare sound
		setTimeout(() => playSound(523, 0.1), 0);    // C
		setTimeout(() => playSound(659, 0.1), 100);  // E
		setTimeout(() => playSound(784, 0.1), 200);  // G
		setTimeout(() => playSound(1047, 0.3), 300); // High C
	}
	
	muteBtn.addEventListener('click', () => {
		isMuted = !isMuted;
		muteBtn.textContent = isMuted ? 'üîá' : 'üîä';
		localStorage.setItem(LS_MUTED, isMuted.toString());
		toast(isMuted ? 'Sound muted' : 'Sound enabled');
	});
	
	// Display mode toggle
	displayRadios.forEach(r => r.addEventListener('change', () => {
		displayMode = r.value;
		localStorage.setItem(LS_DISPLAY, displayMode);
		updateDisplay(wordEl.textContent);
	}));

	// Check for native BarcodeDetector support
	if ('BarcodeDetector' in window) {
		BarcodeDetector.getSupportedFormats().then(formats => {
			if (formats.includes('qr_code')) {
				barcodeDetector = new BarcodeDetector({ formats: ['qr_code'] });
				console.log('Using native BarcodeDetector');
			}
		});
	}

	// Word management
	function loadWords(){
		const saved = localStorage.getItem(LS_KEY);
		if(saved) wordListTA.value = saved;
		// Remove duplicates (case-insensitive) and empty lines
		const lines = wordListTA.value.split(/[\r\n]+/).map(s=>s.trim()).filter(Boolean);
		const seen = new Set();
		return lines.filter(word => {
			const lower = word.toLowerCase();
			if (seen.has(lower)) return false;
			seen.add(lower);
			return true;
		});
	}
	
	function saveWords(){
		localStorage.setItem(LS_KEY, wordListTA.value);
		words = loadWords();
		toast("Saved " + words.length + " words!");
	}
	
	function downloadWords(){
		const text = wordListTA.value;
		const timestamp = new Date().toISOString().slice(0, 10);
		const filename = `qr-words-${timestamp}.txt`;
		
		// Check if Web Share API is available (works on mobile)
		if (navigator.share && /mobile|android|iphone|ipad/i.test(navigator.userAgent)) {
			// Create a blob and file for sharing
			const blob = new Blob([text], { type: 'text/plain' });
			const file = new File([blob], filename, { type: 'text/plain' });
			
			// Use Web Share API to let user choose where to save/share
			navigator.share({
				files: [file],
				title: 'QR Word List',
				text: 'Word list for QR matching game'
			}).then(() => {
				toast("Shared successfully!");
			}).catch(err => {
				// If share fails, fall back to other method
				if (err.name !== 'AbortError') {
					fallbackDownload(text, filename);
				}
			});
		} else {
			fallbackDownload(text, filename);
		}
	}
	
	function fallbackDownload(text, filename) {
		const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
		
		if (isIOS) {
			// For iOS: Create a data URL and open in new tab
			const dataUrl = 'data:text/plain;charset=utf-8,' + encodeURIComponent(text);
			const newWindow = window.open();
			newWindow.document.write(`
				<html>
				<head>
					<title>${filename}</title>
					<meta name="viewport" content="width=device-width, initial-scale=1">
					<style>
						body { font-family: system-ui, -apple-system, sans-serif; padding: 20px; margin: 0; }
						.instructions { margin-bottom: 20px; padding: 15px; background: #007AFF; color: white; border-radius: 10px; }
						.content { padding: 15px; border: 1px solid #ccc; background: white; border-radius: 10px; font-family: monospace; white-space: pre-wrap; word-wrap: break-word; }
						button { background: #007AFF; color: white; border: none; padding: 12px 20px; border-radius: 8px; font-size: 16px; margin: 10px 5px; }
					</style>
				</head>
				<body>
				<div class="instructions">
					<strong style="font-size: 18px;">Save your word list:</strong><br><br>
					1. Tap the <strong>Share button</strong> ‚¨ÜÔ∏è (square with arrow)<br>
					2. Choose where to save:<br>
					   ‚Ä¢ <strong>Save to Files</strong> ‚Üí Pick any folder<br>
					   ‚Ä¢ <strong>Notes</strong> ‚Üí Save as a note<br>
					   ‚Ä¢ <strong>AirDrop</strong> ‚Üí Send to nearby device<br>
					   ‚Ä¢ <strong>Mail/Messages</strong> ‚Üí Send to someone<br><br>
					Or: <button onclick="navigator.clipboard.writeText(document.querySelector('.content').innerText).then(() => alert('Copied to clipboard!'))">Copy All Text</button>
				</div>
				<div class="content">${text}</div>
				</body>
				</html>
			`);
		} else {
			// For desktop/Android: Use normal download
			const blob = new Blob([text], { type: 'text/plain' });
			const url = URL.createObjectURL(blob);
			const a = document.createElement('a');
			a.href = url;
			a.download = filename;
			a.style.display = 'none';
			document.body.appendChild(a);
			a.click();
			setTimeout(() => {
				document.body.removeChild(a);
				URL.revokeObjectURL(url);
			}, 100);
			toast("Check your Downloads folder for: " + filename);
		}
	}
	
	function loadFromFile(e){
		const file = e.target.files[0];
		if (!file) return;
		
		const reader = new FileReader();
		reader.onload = function(event) {
			wordListTA.value = event.target.result;
			saveWords();
			words = loadWords();
			toast("Loaded " + words.length + " words from file!");
			setWord(randomWord());
		};
		reader.readAsText(file);
	}
	
	saveWordsBtn.addEventListener('click', saveWords);
	downloadWordsBtn.addEventListener('click', downloadWords);
	uploadBtn.addEventListener('click', () => fileInput.click());
	fileInput.addEventListener('change', loadFromFile);

	let words = loadWords();
	function randomWord(){ 
		if(words.length===0){words=["gato"];} 
		return words[Math.floor(Math.random()*words.length)]; 
	}
	
	function setWord(w){ 
		lastText = null;
		updateDisplay(w);
	}
	
	function updateDisplay(word) {
		wordEl.textContent = word;
		statusEl.textContent = ""; 
		statusEl.className = "status";
		
		if (displayMode === 'pictogram') {
			wordEl.style.display = 'none';
			pictogramEl.style.display = 'block';
			fetchPictogram(word);
		} else {
			wordEl.style.display = 'block';
			pictogramEl.style.display = 'none';
		}
	}
	
	// Fetch pictogram from ARASAAC API - using first result always
	async function fetchPictogram(word) {
		pictogramEl.innerHTML = '<div style="color: var(--muted);">Loading pictogram...</div>';
		
		try {
			const cleanWord = word.toLowerCase().trim().normalize("NFD").replace(/\p{Diacritic}/gu,"");
			
			// Corrected ARASAAC IDs based on their website
			const wordToId = {
				// Animals - verified IDs
				'gato': 7114,  // cat (corrected)
				'perro': 2517, // dog  
				'raton': 2394, // mouse
				'rat√≥n': 2394, // mouse
				'elefante': 7209, // elephant
				'le√≥n': 29584, // lion
				'leon': 29584, // lion
				'tigre': 7350, // tiger
				'oso': 2395, // bear
				'conejo': 2392, // rabbit
				'p√°jaro': 9652, // bird
				'pajaro': 9652, // bird
				'pez': 2426, // fish
				'vaca': 7377, // cow
				'caballo': 7282, // horse
				'cerdo': 7225, // pig
				'oveja': 7233, // sheep
				'pollo': 7235, // chicken
				'pato': 7162, // duck
				
				// Objects/Places
				'casa': 2433, // house
				'castillo': 37166, // castle
				'escuela': 2670, // school
				'√°rbol': 5678, // tree
				'arbol': 5678, // tree
				'sol': 2435, // sun
				'luna': 5720, // moon
				'estrella': 5719, // star
				'agua': 2244, // water
				'fuego': 6039, // fire
				'coche': 2446, // car
				'libro': 2390, // book
				'mesa': 2389, // table
				'silla': 2632, // chair
				'cama': 6036, // bed
				'puerta': 7324, // door
				'ventana': 7378, // window
				'pelota': 7298, // ball
				'juguete': 5746, // toy
				
				// Numbers
				'uno': 9783,
				'dos': 9788,
				'tres': 9824,
				'cuatro': 9763,
				'cinco': 9759,
				'seis': 9817,
				'siete': 9818,
				'ocho': 9800,
				'nueve': 9799,
				'diez': 9767,
				
				// Add more as needed...
			};
			
			// Try to find the word in our mapping
			let pictogramId = wordToId[cleanWord];
			
			// If not found, try some variations
			if (!pictogramId) {
				// Try without final 's' for plurals
				if (cleanWord.endsWith('s')) {
					const singular = cleanWord.slice(0, -1);
					pictogramId = wordToId[singular];
				}
			}
			
			// If we found a pictogram ID, display it
			if (pictogramId) {
				const imgUrl = `https://api.arasaac.org/v1/pictograms/${pictogramId}?download=false&color=true`;
				console.log('Loading pictogram for "' + word + '" with ID:', pictogramId);
				
				pictogramEl.innerHTML = `
					<img src="${imgUrl}" 
						 alt="${word}" 
						 style="max-width: 200px; height: auto; border-radius: 8px; border: 2px solid #1c2432;">
				`;
			} else {
				// Use emoji fallback
				const emojiMap = {
					'gato': 'üê±',
					'perro': 'üêï',
					'rat√≥n': 'üê≠',
					'raton': 'üê≠',
					'elefante': 'üêò',
					'casa': 'üè†',
					'castillo': 'üè∞',
					'sol': '‚òÄÔ∏è',
					'luna': 'üåô',
					'estrella': '‚≠ê',
					'√°rbol': 'üå≥',
					'arbol': 'üå≥',
					'agua': 'üíß',
					'fuego': 'üî•',
					'coche': 'üöó',
					'libro': 'üìö',
					'pelota': '‚öΩ',
					'uno': '1Ô∏è‚É£',
					'dos': '2Ô∏è‚É£',
					'tres': '3Ô∏è‚É£',
					'cuatro': '4Ô∏è‚É£',
					'cinco': '5Ô∏è‚É£',
					'seis': '6Ô∏è‚É£',
					'siete': '7Ô∏è‚É£',
					'ocho': '8Ô∏è‚É£',
					'nueve': '9Ô∏è‚É£',
					'diez': 'üîü'
				};
				
				const emoji = emojiMap[cleanWord];
				if (emoji) {
					pictogramEl.innerHTML = `<div style="font-size: 120px; line-height: 1;">${emoji}</div>`;
				} else {
					pictogramEl.innerHTML = `
						<div style="font-size: 48px; font-weight: bold; color: var(--fg);">
							${word}
						</div>
						<div style="color: var(--muted); font-size: 12px; margin-top: 10px;">No pictogram available</div>
					`;
				}
			}
		} catch (error) {
			console.error('Error loading pictogram:', error);
			pictogramEl.innerHTML = '<div style="color: var(--muted); font-size: 12px;">Could not load pictogram</div>';
		}
	}

	function normalize(s){
		if(modeSel.value==="exact") return s.trim();
		return s.normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase().trim();
	}
	
	function celebrate(){
		if (typeof confetti === 'function') {
			confetti({ particleCount: 90, spread: 65, origin: { y: 0.6 } });
		}
	}
	
	function megaCelebrate(){
		if (typeof confetti === 'function') {
			// Multiple bursts for big milestone
			const count = 200;
			const defaults = { origin: { y: 0.7 } };
			
			function fire(particleRatio, opts) {
				confetti({
					...defaults,
					...opts,
					particleCount: Math.floor(count * particleRatio)
				});
			}
			
			fire(0.25, { spread: 26, startVelocity: 55 });
			fire(0.2, { spread: 60 });
			fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
			fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
			fire(0.1, { spread: 120, startVelocity: 45 });
		}
	}
	
	function showBigNumber(num) {
		const el = document.createElement('div');
		el.id = 'bigMilestone';
		el.textContent = num;
		document.body.appendChild(el);
		setTimeout(() => el.remove(), 1500);
	}
	
	function updateStars() {
		// Show stars for correct words (last 10)
		const recentStars = correctWords.slice(-10).map(() => '‚≠ê').join('');
		starsEl.innerHTML = recentStars;
		
		// Animate new star
		if (correctWords.length > 0) {
			starsEl.style.animation = 'none';
			setTimeout(() => {
				starsEl.style.animation = 'pulse 0.5s ease-in-out';
			}, 10);
		}
	}
	
	function updateScore(ok){
		if(ok){ 
			score += 1; 
			streak += 1;
			correctWords.push(wordEl.textContent);
			updateStars();
			
			// Play sound
			playCorrectSound();
			
			// Check for milestones with big number display
			if (streak === 3) {
				toast("üéâ 3 in a row! Great job!");
				celebrate();
				showBigNumber(3);
			} else if (streak === 10) {
				toast("üèÜ 10 STREAK! AMAZING!");
				megaCelebrate();
				playMilestoneSound();
				showBigNumber(10);
			} else if (streak === 20) {
				toast("üåü 20 STREAK! YOU'RE A CHAMPION!");
				megaCelebrate();
				playMilestoneSound();
				showBigNumber(20);
			} else if (streak % 5 === 0 && streak > 0) {
				toast(`üî• ${streak} streak! Keep going!`);
				celebrate();
			}
		} else { 
			streak = 0; 
		}
		scoreTag.textContent = "Score: " + score;
		streakTag.textContent = "Streak: " + streak + " üî•";
	}
	
	function toast(msg){
		const el = document.createElement('div');
		el.textContent = msg;
		el.style.cssText = "position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#111722;border:1px solid #1c2432;padding:8px 12px;border-radius:999px;color:var(--fg);box-shadow:0 8px 30px rgba(0,0,0,.4);z-index:9999";
		document.body.appendChild(el);
		setTimeout(()=> el.remove(), 2000);
	}

	// QR Code detection
	async function scanFrame() {
		if (!scanning || !video.videoWidth) return;

		canvas.width = video.videoWidth;
		canvas.height = video.videoHeight;
		ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

		try {
			let decodedText = null;

			// Try native BarcodeDetector first
			if (barcodeDetector) {
				const barcodes = await barcodeDetector.detect(canvas);
				if (barcodes.length > 0) {
					decodedText = barcodes[0].rawValue;
				}
			} 
			// Fall back to jsQR
			else if (typeof jsQR !== 'undefined') {
				const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
				const code = jsQR(imageData.data, imageData.width, imageData.height);
				if (code) {
					decodedText = code.data;
				}
			}

			if (decodedText && decodedText !== lastText) {
				lastText = decodedText;
				const currentWord = wordEl.textContent;
				const ok = normalize(decodedText) === normalize(currentWord);
				updateScore(ok);
				
				if (ok) {
					statusEl.textContent = "‚úì Correct: " + decodedText;
					statusEl.className = "status ok";
					celebrate();
					
					// Move to next word after a short delay, keep camera running
					setTimeout(() => {
						setWord(randomWord());
						lastText = null; // Reset so we can scan the same QR for a different word
					}, 1000);
				} else {
					statusEl.textContent = "‚úñ Not matched: " + decodedText;
					statusEl.className = "status bad";
				}
			}
		} catch (err) {
			// Silently handle scan errors
		}
	}

	// Camera controls - always use back camera
	async function start() {
		if (scanning) return;
		
		try {
			errEl.textContent = "";
			
			// Always use back camera (environment)
			const constraints = {
				video: {
					facingMode: 'environment',
					width: { ideal: 1280 },
					height: { ideal: 720 }
				}
			};

			// Stop any existing stream first
			if (stream) {
				stream.getTracks().forEach(track => track.stop());
				stream = null;
			}

			stream = await navigator.mediaDevices.getUserMedia(constraints);
			video.srcObject = stream;
			await video.play();
			
			videoContainer.style.display = 'block';
			scanning = true;
			startBtn.disabled = true;
			stopBtn.disabled = false;
			nextBtn.disabled = true;

			// Start scanning
			if (scanInterval) clearInterval(scanInterval);
			scanInterval = setInterval(scanFrame, 100);
			
		} catch (err) {
			let errorMsg = "Camera error: " + (err.message || err);
			
			if (err.name === 'NotAllowedError') {
				errorMsg = `üì∑ Camera blocked. To fix: Click the lock icon in your address bar ‚Üí Set Camera to "Allow" ‚Üí Refresh page`;
			} else if (err.name === 'NotFoundError') {
				errorMsg = "No camera detected on this device";
			} else if (err.name === 'NotReadableError') {
				errorMsg = "Camera is being used by another app. Close other apps using the camera.";
			} else if (err.name === 'OverconstrainedError') {
				errorMsg = "Back camera not available.";
			}
			
			errEl.innerHTML = errorMsg;
			scanning = false;
			startBtn.disabled = false;
			stopBtn.disabled = true;
		}
	}

	async function stop() {
		if (!scanning) return;
		
		scanning = false;
		
		if (scanInterval) {
			clearInterval(scanInterval);
			scanInterval = null;
		}
		
		if (stream) {
			stream.getTracks().forEach(track => track.stop());
			stream = null;
		}
		
		video.srcObject = null;
		videoContainer.style.display = 'none';
		startBtn.disabled = false;
		stopBtn.disabled = true;
		nextBtn.disabled = false;
		lastText = null;
	}

	// Event listeners
	startBtn.addEventListener('click', start);
	stopBtn.addEventListener('click', stop);
	nextBtn.addEventListener('click', () => setWord(randomWord()));

	// Initialize
	setWord(randomWord());
	</script>
</body>
</html>