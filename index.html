<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
	<title>QR Word Match</title>
	<meta name="color-scheme" content="dark light">
	<style>
		:root { --bg:#0b0d12; --fg:#f7f7f7; --muted:#a8b0bd; --ok:#1cc88a; --bad:#ff5d5d; }
		* { box-sizing: border-box; }
		body { margin: 0; padding: 0; background: var(--bg); color: var(--fg);
			font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
			display: grid; min-height: 100vh; grid-template-rows: auto 1fr auto; }
		header, footer { padding: 12px 16px; background: #0f131a; border-bottom: 1px solid #151a22; }
		header h1 { margin: 0; font-size: 18px; letter-spacing: .4px; }
		main { padding: 14px; display: grid; gap: 12px; align-content: start; }
		.card { background: #111722; border: 1px solid #1c2432; border-radius: 14px; padding: 12px; display: grid; gap: 10px; }
		button, select { background: #1a2230; color: var(--fg); border: 1px solid #2a3548; border-radius: 10px;
			padding: 10px 14px; font-size: 16px; cursor: pointer; }
		button:active { transform: translateY(1px); }
		button:disabled { opacity: 0.5; cursor: not-allowed; }
		.word { font-size: clamp(28px, 7vw, 60px); text-align: center; font-weight: 800; letter-spacing: .8px;
			padding: 12px 10px; border-radius: 12px; background: #0f1520; border: 1px dashed #25324a; }
		.status { text-align: center; font-weight: 700; min-height: 1.2em; }
		.status.ok { color: var(--ok); } .status.bad { color: var(--bad); }
		
		/* Video container styles */
		#videoContainer { 
			width: 100%; 
			max-width: 560px; 
			margin: 0 auto; 
			border-radius: 12px; 
			overflow: hidden;
			border: 1px solid #283449; 
			background: #0a0f16; 
			position: relative;
			aspect-ratio: 4/3;
		}
		#video { 
			width: 100%;
			height: 100%;
			object-fit: cover;
			display: block;
		}
		#canvas {
			display: none;
		}
		.scan-region {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			width: 250px;
			height: 250px;
			border: 2px solid rgba(28, 200, 138, 0.6);
			border-radius: 12px;
			box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.5);
		}
		.scan-line {
			position: absolute;
			width: 100%;
			height: 2px;
			background: linear-gradient(90deg, transparent, #1cc88a, transparent);
			animation: scan 2s linear infinite;
		}
		@keyframes scan {
			0% { top: 0; }
			100% { top: calc(100% - 2px); }
		}
		
		.small { color: var(--muted); font-size: 12px; }
		.row { display: flex; gap: 8px; flex-wrap: wrap; align-items:center; }
		.tag { font-size: 12px; color: var(--muted); background:#0d1420; border:1px solid #1f2a3d; padding:6px 8px; border-radius:999px;}
		.selects { display:flex; gap:8px; align-items:center; flex-wrap: wrap; }
		.toggle { display:flex; gap:6px; background:#0d1420; border:1px solid #1f2a3d; padding:6px; border-radius:999px; }
		.toggle label { padding:6px 10px; border-radius:999px; cursor:pointer; user-select:none; }
		.toggle input { display:none; }
		.toggle input:checked + span { background:#1a2230; border:1px solid #2a3548; }
		.loading { padding: 20px; text-align: center; color: var(--muted); }
	</style>
</head>
<body>
	<header><h1>QR Word Match</h1></header>
	<main>
		<div class="card">
			<div class="row" style="justify-content:space-between;">
				<div class="row">
					<button id="startBtn">Start camera</button>
					<button id="stopBtn" disabled>Stop</button>
					<button id="nextBtn">New word</button>
				</div>
				<div class="selects">
					<div class="toggle" title="Camera selection">
						<label><input type="radio" name="camera" value="environment" checked><span>Back</span></label>
						<label><input type="radio" name="camera" value="user"><span>Front</span></label>
					</div>
					<select id="mode">
						<option value="exact" selected>Exact match</option>
						<option value="loose">Ignore accents & case</option>
					</select>
				</div>
			</div>
			<div id="currentWord" class="word" aria-live="polite">gato</div>
			<div class="status" id="status"></div>
			
			<div id="videoContainer" style="display:none;">
				<video id="video" playsinline></video>
				<div class="scan-region">
					<div class="scan-line"></div>
				</div>
			</div>
			<canvas id="canvas"></canvas>
			
			<div class="row">
				<div class="tag" id="scoreTag">Score: 0</div>
				<div class="tag" id="streakTag">Streak: 0 ðŸ”¥</div>
			</div>
			<div id="err" class="small" style="color:#ff8c8c;"></div>
			<details style="margin-top: 8px;">
				<summary style="cursor: pointer; color: var(--muted); font-size: 12px;">ðŸ“· Camera troubleshooting</summary>
				<div style="padding: 10px; font-size: 12px; color: var(--muted); line-height: 1.5;">
					<strong>If camera won't start:</strong><br>
					â€¢ First time? Click "Allow" when browser asks for camera permission<br>
					â€¢ Blocked before? Click lock icon in address bar â†’ Camera â†’ Allow â†’ Refresh<br>
					â€¢ On iPhone? Use Safari (Chrome on iOS doesn't support cameras well)<br>
					â€¢ Still stuck? Try switching between Front/Back options
				</div>
			</details>
		</div>

		<div class="card">
			<strong>Word list</strong>
			<p class="small">Edit below to customize. One word per line.</p>
			<textarea id="wordList" rows="6" style="width:100%; background:#0f1520; color:var(--fg); border:1px solid #25324a; border-radius:10px; padding:10px; font-size:15px;">gato
ratÃ³n
castillo
elefante
perro
tres</textarea>
			<div class="row">
				<button id="saveWords">Save list</button>
				<span class="small">Saved to your browser.</span>
			</div>
		</div>
	</main>
	<footer><span class="small">Use over HTTPS for camera access. Using native camera API.</span></footer>

	<!-- Load confetti for celebrations -->
	<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
	<!-- Load jsQR as fallback QR reader -->
	<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

	<script>
	// UI Elements
	const wordEl = document.getElementById('currentWord');
	const statusEl = document.getElementById('status');
	const startBtn = document.getElementById('startBtn');
	const stopBtn = document.getElementById('stopBtn');
	const nextBtn = document.getElementById('nextBtn');
	const modeSel = document.getElementById('mode');
	const wordListTA = document.getElementById('wordList');
	const saveWordsBtn = document.getElementById('saveWords');
	const scoreTag = document.getElementById('scoreTag');
	const streakTag = document.getElementById('streakTag');
	const cameraRadios = document.querySelectorAll('input[name="camera"]');
	const errEl = document.getElementById('err');
	const video = document.getElementById('video');
	const canvas = document.getElementById('canvas');
	const ctx = canvas.getContext('2d');
	const videoContainer = document.getElementById('videoContainer');

	// State
	const LS_KEY = "qr-word-game:list";
	const LS_CAMERA = "qr-word-game:camera";
	let stream = null;
	let scanning = false;
	let score = 0, streak = 0;
	let lastText = null;
	let scanInterval = null;
	let barcodeDetector = null;

	// Check for native BarcodeDetector support
	if ('BarcodeDetector' in window) {
		BarcodeDetector.getSupportedFormats().then(formats => {
			if (formats.includes('qr_code')) {
				barcodeDetector = new BarcodeDetector({ formats: ['qr_code'] });
				console.log('Using native BarcodeDetector');
			}
		});
	}

	// Word management
	function loadWords(){
		const saved = localStorage.getItem(LS_KEY);
		if(saved) wordListTA.value = saved;
		return wordListTA.value.split(/[\r\n]+/).map(s=>s.trim()).filter(Boolean);
	}
	
	function saveWords(){
		localStorage.setItem(LS_KEY, wordListTA.value);
		words = loadWords();
		toast("Saved!");
	}
	saveWordsBtn.addEventListener('click', saveWords);

	let words = loadWords();
	function randomWord(){ 
		if(words.length===0){words=["gato"];} 
		return words[Math.floor(Math.random()*words.length)]; 
	}
	
	function setWord(w){ 
		wordEl.textContent=w; 
		statusEl.textContent=""; 
		statusEl.className="status";
		lastText = null;
	}

	function normalize(s){
		if(modeSel.value==="exact") return s.trim();
		return s.normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase().trim();
	}
	
	function celebrate(){
		if (typeof confetti === 'function') {
			confetti({ particleCount: 90, spread: 65, origin: { y: 0.6 } });
		}
	}
	
	function updateScore(ok){
		if(ok){ 
			score += 1; 
			streak += 1; 
		} else { 
			streak = 0; 
		}
		scoreTag.textContent = "Score: " + score;
		streakTag.textContent = "Streak: " + streak + " ðŸ”¥";
	}
	
	function toast(msg){
		const el = document.createElement('div');
		el.textContent = msg;
		el.style.cssText = "position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#111722;border:1px solid #1c2432;padding:8px 12px;border-radius:999px;color:var(--fg);box-shadow:0 8px 30px rgba(0,0,0,.4);z-index:9999";
		document.body.appendChild(el);
		setTimeout(()=> el.remove(), 1200);
	}

	function getCamera(){
		const saved = localStorage.getItem(LS_CAMERA);
		if (saved) { 
			for (const r of cameraRadios) {
				if (r.value === saved) r.checked = true;
			}
		}
		const r = Array.from(cameraRadios).find(r => r.checked); 
		return r ? r.value : "environment";
	}
	
	cameraRadios.forEach(r => r.addEventListener('change', async () => {
		localStorage.setItem(LS_CAMERA, getCamera());
		if (scanning) { 
			await stop(); 
			await start(); 
		}
	}));

	// QR Code detection
	async function scanFrame() {
		if (!scanning || !video.videoWidth) return;

		canvas.width = video.videoWidth;
		canvas.height = video.videoHeight;
		ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

		try {
			let decodedText = null;

			// Try native BarcodeDetector first
			if (barcodeDetector) {
				const barcodes = await barcodeDetector.detect(canvas);
				if (barcodes.length > 0) {
					decodedText = barcodes[0].rawValue;
				}
			} 
			// Fall back to jsQR
			else if (typeof jsQR !== 'undefined') {
				const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
				const code = jsQR(imageData.data, imageData.width, imageData.height);
				if (code) {
					decodedText = code.data;
				}
			}

			if (decodedText && decodedText !== lastText) {
				lastText = decodedText;
				const ok = normalize(decodedText) === normalize(wordEl.textContent);
				updateScore(ok);
				
				if (ok) {
					statusEl.textContent = "âœ“ Correct: " + decodedText;
					statusEl.className = "status ok";
					celebrate();
					
					// Stop scanning after correct match
					stop();
					
					// Automatically show next word after a delay
					setTimeout(() => {
						setWord(randomWord());
						statusEl.textContent = "Press Start to scan for the new word";
						statusEl.className = "status";
					}, 1500);
				} else {
					statusEl.textContent = "âœ– Not matched: " + decodedText;
					statusEl.className = "status bad";
				}
			}
		} catch (err) {
			// Silently handle scan errors
		}
	}

	// Camera controls
	async function start() {
		if (scanning) return;
		
		try {
			errEl.textContent = "";
			
			const constraints = {
				video: {
					facingMode: getCamera(),
					width: { ideal: 1280 },
					height: { ideal: 720 }
				}
			};

			stream = await navigator.mediaDevices.getUserMedia(constraints);
			video.srcObject = stream;
			await video.play();
			
			videoContainer.style.display = 'block';
			scanning = true;
			startBtn.disabled = true;
			stopBtn.disabled = false;
			nextBtn.disabled = true;

			// Start scanning
			scanInterval = setInterval(scanFrame, 100);
			
		} catch (err) {
			let errorMsg = "Camera error: " + (err.message || err);
			
			if (err.name === 'NotAllowedError') {
				errorMsg = `ðŸ“· Camera blocked. To fix: Click the lock icon in your address bar â†’ Set Camera to "Allow" â†’ Refresh page`;
			} else if (err.name === 'NotFoundError') {
				errorMsg = "No camera detected on this device";
			} else if (err.name === 'NotReadableError') {
				errorMsg = "Camera is being used by another app. Close other apps using the camera.";
			}
			
			errEl.innerHTML = errorMsg;
			scanning = false;
			startBtn.disabled = false;
			stopBtn.disabled = true;
		}
	}

	async function stop() {
		if (!scanning) return;
		
		if (scanInterval) {
			clearInterval(scanInterval);
			scanInterval = null;
		}
		
		if (stream) {
			stream.getTracks().forEach(track => track.stop());
			stream = null;
		}
		
		video.srcObject = null;
		videoContainer.style.display = 'none';
		scanning = false;
		startBtn.disabled = false;
		stopBtn.disabled = true;
		nextBtn.disabled = false;
		lastText = null;
	}

	// Event listeners
	startBtn.addEventListener('click', start);
	stopBtn.addEventListener('click', stop);
	nextBtn.addEventListener('click', () => setWord(randomWord()));

	// Initialize
	setWord(randomWord());
	getCamera();
	</script>
</body>
</html>