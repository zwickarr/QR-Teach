<!doctype html>
<html lang="en">
<head>
	<meta charset="utf-8" />
	<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
	<title>QR Word Match</title>
	<style>
		* { box-sizing: border-box; margin: 0; padding: 0; }
		
		/* Light theme */
		body.light { 
			background: linear-gradient(135deg, #89f7fe 0%, #66a6ff 100%);
			color: #2c3e50;
		}
		.light header { 
			background: white;
			color: #2c3e50;
			box-shadow: 0 2px 10px rgba(0,0,0,0.1);
		}
		.light .card { 
			background: white;
			color: #2c3e50;
			box-shadow: 0 10px 30px rgba(0,0,0,0.1);
		}
		.light button { 
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
			box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
		}
		.light select, .light textarea {
			background: #f8f9fa;
			color: #2c3e50;
			border: 2px solid #e0e6ed;
		}
		.light .word { 
			background: linear-gradient(135deg, #fa709a 0%, #fee140 100%);
			color: white;
		}
		.light .toggle {
			background: #f0f3ff;
		}
		.light .toggle input:checked + span {
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			color: white;
		}
		.light .tag { 
			color: #667eea;
			background: #f0f3ff;
		}
		.light footer {
			background: white;
			color: #718096;
			box-shadow: 0 -2px 10px rgba(0,0,0,0.1);
		}
		.light #videoContainer {
			background: white;
			box-shadow: 0 10px 30px rgba(0,0,0,0.2);
		}
		
		/* Dark theme */
		body.dark { 
			background: #0b0d12;
			color: #f7f7f7;
		}
		.dark header { 
			background: #0f131a;
			color: #f7f7f7;
			border-bottom: 1px solid #151a22;
		}
		.dark .card { 
			background: #111722;
			color: #f7f7f7;
			border: 1px solid #1c2432;
		}
		.dark button { 
			background: #1a2230;
			color: #f7f7f7;
			border: 1px solid #2a3548;
		}
		.dark button:hover {
			background: #2a3548;
		}
		.dark select, .dark textarea {
			background: #0f1520;
			color: #f7f7f7;
			border: 1px solid #25324a;
		}
		.dark .word { 
			background: #0f1520;
			color: #f7f7f7;
			border: 1px dashed #25324a;
		}
		.dark .toggle {
			background: #0d1420;
			border: 1px solid #1f2a3d;
		}
		.dark .toggle input:checked + span {
			background: #1a2230;
			color: #f7f7f7;
			border: 1px solid #2a3548;
		}
		.dark .tag { 
			color: #a8b0bd;
			background: #0d1420;
			border: 1px solid #1f2a3d;
		}
		.dark footer {
			background: #0f131a;
			color: #a8b0bd;
			border-top: 1px solid #151a22;
		}
		.dark #videoContainer {
			background: #0a0f16;
			border: 1px solid #283449;
		}
		.dark .small {
			color: #a8b0bd;
		}
		.dark #err {
			color: #ff8c8c;
		}
		
		/* Common styles */
		body {
			font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
			display: flex;
			flex-direction: column;
			min-height: 100vh;
			transition: background 0.3s ease;
		}
		header { 
			padding: 16px 20px;
			display: flex;
			justify-content: space-between;
			align-items: center;
		}
		header h1 { 
			font-size: 24px;
			font-weight: bold;
		}
		main { 
			flex: 1;
			padding: 20px;
			display: flex;
			flex-direction: column;
			gap: 20px;
			max-width: 800px;
			margin: 0 auto;
			width: 100%;
		}
		.card { 
			border-radius: 20px;
			padding: 20px;
		}
		button { 
			border: none;
			border-radius: 12px;
			padding: 12px 20px;
			font-size: 16px;
			font-weight: 600;
			cursor: pointer;
			transition: transform 0.2s, box-shadow 0.2s;
		}
		button:hover {
			transform: translateY(-2px);
		}
		button:active { transform: translateY(0); }
		button:disabled { 
			opacity: 0.5; 
			cursor: not-allowed;
			transform: none;
		}
		select, textarea {
			border-radius: 10px;
			padding: 10px 15px;
			font-size: 16px;
		}
		select {
			cursor: pointer;
		}
		textarea {
			padding: 12px;
			font-family: monospace;
			resize: vertical;
		}
		.word { 
			font-size: clamp(36px, 8vw, 72px);
			text-align: center;
			font-weight: 900;
			padding: 30px 20px;
			border-radius: 20px;
			text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
			margin: 20px 0;
		}
		.status { 
			text-align: center;
			font-weight: 700;
			font-size: 18px;
			min-height: 30px;
			margin: 10px 0;
		}
		.status.ok { color: #00d084; }
		.status.bad { color: #ff6b6b; }
		
		#videoContainer { 
			width: 100%;
			max-width: 500px;
			margin: 20px auto;
			border-radius: 20px;
			overflow: hidden;
			position: relative;
			aspect-ratio: 4/3;
		}
		#video { 
			width: 100%;
			height: 100%;
			object-fit: cover;
			display: block;
		}
		#canvas { display: none; }
		.scan-region {
			position: absolute;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			width: 250px;
			height: 250px;
			border: 3px solid #00d084;
			border-radius: 20px;
			box-shadow: 0 0 0 9999px rgba(0, 0, 0, 0.3);
		}
		.scan-line {
			position: absolute;
			width: 100%;
			height: 3px;
			background: linear-gradient(90deg, transparent, #00d084, transparent);
			animation: scan 2s linear infinite;
		}
		@keyframes scan {
			0% { top: 0; }
			100% { top: calc(100% - 3px); }
		}
		@keyframes pulse {
			0%, 100% { transform: scale(1); }
			50% { transform: scale(1.2); }
		}
		@keyframes bigNumber {
			0% { transform: scale(0) rotate(0deg); opacity: 0; }
			50% { transform: scale(1.5) rotate(180deg); opacity: 1; }
			100% { transform: scale(1) rotate(360deg); opacity: 1; }
		}
		
		#stars { 
			text-align: center;
			font-size: 32px;
			min-height: 40px;
			margin: 10px 0;
		}
		#pictogram {
			text-align: center;
			margin: 20px 0;
			min-height: 200px;
			display: none;
		}
		#pictogram img {
			max-width: 250px;
			height: auto;
			border-radius: 12px;
		}
		#muteBtn, #themeBtn {
			font-size: 24px;
			padding: 10px 15px;
			min-width: 60px;
		}
		#bigMilestone {
			position: fixed;
			top: 50%;
			left: 50%;
			transform: translate(-50%, -50%);
			font-size: 200px;
			font-weight: bold;
			background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
			-webkit-background-clip: text;
			-webkit-text-fill-color: transparent;
			animation: bigNumber 1s ease-out;
			pointer-events: none;
			z-index: 10000;
		}
		
		.row { 
			display: flex;
			gap: 10px;
			flex-wrap: wrap;
			align-items: center;
			margin: 10px 0;
		}
		.tag { 
			font-size: 14px;
			font-weight: 600;
			padding: 8px 16px;
			border-radius: 999px;
		}
		.selects {
			display: flex;
			gap: 10px;
			align-items: center;
			flex-wrap: wrap;
		}
		.toggle {
			display: flex;
			gap: 4px;
			padding: 4px;
			border-radius: 999px;
		}
		.toggle label {
			padding: 8px 16px;
			border-radius: 999px;
			cursor: pointer;
			user-select: none;
			font-weight: 600;
			transition: all 0.3s;
		}
		.toggle input { display: none; }
		details {
			margin: 10px 0;
		}
		details summary {
			cursor: pointer;
			user-select: none;
			font-weight: bold;
			font-size: 18px;
			padding: 10px 0;
		}
		details summary:hover {
			color: #667eea;
		}
		footer {
			padding: 16px;
			text-align: center;
			font-size: 14px;
		}
		#err {
			font-size: 14px;
			margin: 10px 0;
		}
		.small {
			font-size: 13px;
		}
		#loadingMsg {
			text-align: center;
			padding: 20px;
			font-style: italic;
		}
	</style>
</head>
<body class="light">
	<header>
		<h1>🎯 QR Word Match Game</h1>
		<button id="themeBtn" title="Toggle theme">🌙</button>
	</header>
	<main>
		<div class="card">
			<div class="row" style="justify-content:space-between;">
				<div class="row">
					<button id="startBtn">Start camera</button>
					<button id="stopBtn" disabled>Stop</button>
					<button id="nextBtn">New word</button>
					<button id="muteBtn" title="Toggle sound">🔊</button>
				</div>
				<div class="selects">
					<select id="mode">
						<option value="exact" selected>Exact match</option>
						<option value="loose">Ignore accents & case</option>
					</select>
					<div class="toggle" title="Display mode">
						<label><input type="radio" name="display" value="word" checked><span>Word</span></label>
						<label><input type="radio" name="display" value="pictogram"><span>Pictogram</span></label>
					</div>
				</div>
			</div>
			<div id="currentWord" class="word" aria-live="polite">gato</div>
			<div id="pictogram"></div>
			<div id="stars"></div>
			<div class="status" id="status"></div>
			
			<div id="videoContainer" style="display:none;">
				<video id="video" playsinline></video>
				<div class="scan-region">
					<div class="scan-line"></div>
				</div>
			</div>
			<canvas id="canvas"></canvas>
			
			<div class="row">
				<div class="tag" id="scoreTag">Score: 0</div>
				<div class="tag" id="streakTag">Streak: 0 🔥</div>
			</div>
			<div id="err"></div>
			<details style="margin-top: 8px;">
				<summary style="cursor: pointer; font-size: 12px;">📷 Camera troubleshooting</summary>
				<div style="padding: 10px; font-size: 12px; line-height: 1.5;">
					<strong>If camera won't start:</strong><br>
					• First time? Click "Allow" when browser asks for camera permission<br>
					• Blocked before? Click lock icon in address bar → Camera → Allow → Refresh<br>
					• On iPhone? Use Safari (Chrome on iOS doesn't support cameras well)<br>
					• Camera stuck? Try Stop then Start again<br>
					• Still stuck? Refresh the page
				</div>
			</details>
		</div>

		<div class="card">
			<details open>
				<summary style="font-weight: bold; margin-bottom: 8px;">Word list</summary>
				<p class="small">Edit below to customize. One word per line. Duplicates are automatically removed (case-insensitive).</p>
				<textarea id="wordList" rows="6">gato
ratón
castillo
elefante
perro
tres</textarea>
				<div class="row" style="margin-top: 10px;">
					<button id="saveWords">Save list</button>
					<button id="downloadWords">Download list</button>
					<button id="uploadBtn">Load from file</button>
					<button id="loadArasaacBtn" style="background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);">Load ARASAAC words</button>
					<input type="file" id="fileInput" accept=".txt" style="display:none;">
				</div>
				<div id="loadingMsg" style="display:none;">Loading validated words from ARASAAC...</div>
			</details>
			<details style="margin-top: 8px;">
				<summary style="cursor: pointer; font-size: 12px;">📁 File handling tips</summary>
				<div style="padding: 10px; font-size: 12px; line-height: 1.5;">
					<strong>iPhone/iPad:</strong><br>
					• Downloads go to Files app → Downloads folder<br>
					• In Safari: Tap download icon in address bar<br>
					• To load: Tap "Load from file" → Browse → Downloads<br><br>
					<strong>Android:</strong><br>
					• Downloads go to Downloads folder<br>
					• Check notification or Downloads app<br><br>
					<strong>ARASAAC Words:</strong><br>
					• Click "Load ARASAAC words" to get validated Spanish words with pictograms<br>
					• These words are guaranteed to have pictogram images
				</div>
			</details>
		</div>
	</main>
	<footer>
		<span class="small">Use over HTTPS for camera access. Pictograms from ARASAAC.org</span>
	</footer>

	<!-- Load confetti for celebrations -->
	<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
	<!-- Load jsQR as fallback QR reader -->
	<script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>

	<script>
	// Theme management
	const themeBtn = document.getElementById('themeBtn');
	const body = document.body;
	const savedTheme = localStorage.getItem('qr-word-game:theme') || 'light';
	body.className = savedTheme;
	themeBtn.textContent = savedTheme === 'light' ? '🌙' : '☀️';
	
	themeBtn.addEventListener('click', () => {
		const newTheme = body.className === 'light' ? 'dark' : 'light';
		body.className = newTheme;
		themeBtn.textContent = newTheme === 'light' ? '🌙' : '☀️';
		localStorage.setItem('qr-word-game:theme', newTheme);
	});
	
	// UI Elements
	const wordEl = document.getElementById('currentWord');
	const statusEl = document.getElementById('status');
	const startBtn = document.getElementById('startBtn');
	const stopBtn = document.getElementById('stopBtn');
	const nextBtn = document.getElementById('nextBtn');
	const muteBtn = document.getElementById('muteBtn');
	const modeSel = document.getElementById('mode');
	const wordListTA = document.getElementById('wordList');
	const saveWordsBtn = document.getElementById('saveWords');
	const downloadWordsBtn = document.getElementById('downloadWords');
	const uploadBtn = document.getElementById('uploadBtn');
	const loadArasaacBtn = document.getElementById('loadArasaacBtn');

// Pin IDs for current list (batch) + export
const pinBtn = document.getElementById('pinIdsBtn');
const exportPinnedBtn = document.getElementById('exportPinnedBtn');
pinBtn?.addEventListener('click', async ()=>{
	try{
		pinBtn.disabled = true;
		__nsLog && __nsLog('Pinning IDs for current list...');
		const list = loadWords();
		let pinnedCount = 0;
		for (const w of list){
			if (!w) continue;
			const id = await resolvePictogramId(w);
			if (id){ setPinned(w, id); pinnedCount++; try{ await fetch(`https://frosty-snowflake-66a2.john-zwicker.workers.dev/pictos/${id}.png`);}catch(e){} }
			await new Promise(r=>setTimeout(r, 150));
		}
		toast(`Pinned ${pinnedCount} IDs`);
		__nsLog && __nsLog(`Pinned ${pinnedCount} IDs (and prewarmed cache)`);
	} catch(e){ console.error(e); toast('Pinning failed'); }
	finally { pinBtn.disabled = false; }
});
exportPinnedBtn?.addEventListener('click', ()=>{
	try{
		const blob = new Blob([JSON.stringify(pinnedIds, null, 2)], {type:'application/json'});
		const url = URL.createObjectURL(blob);
		const a = document.createElement('a'); a.href=url; a.download='pinned-ids.json'; document.body.appendChild(a); a.click(); a.remove(); URL.revokeObjectURL(url);
	} catch(e){}
});

	const fileInput = document.getElementById('fileInput');
	const scoreTag = document.getElementById('scoreTag');
	const streakTag = document.getElementById('streakTag');
	const displayRadios = document.querySelectorAll('input[name="display"]');
	const errEl = document.getElementById('err');
	const video = document.getElementById('video');
	const canvas = document.getElementById('canvas');
	const ctx = canvas.getContext('2d');
	const videoContainer = document.getElementById('videoContainer');
	const starsEl = document.getElementById('stars');
	const pictogramEl = document.getElementById('pictogram');
	const loadingMsg = document.getElementById('loadingMsg');

	// State
	const LS_KEY = "qr-word-game:list";
	const LS_MUTED = "qr-word-game:muted";
	const LS_DISPLAY = "qr-word-game:display";
	let stream = null;
	let scanning = false;
	let score = 0, streak = 0;
	let lastText = null;
	let scanInterval = null;
	let barcodeDetector = null;
	let isMuted = localStorage.getItem(LS_MUTED) === 'true';
	let audioContext = null;
	let correctWords = [];
	let displayMode = localStorage.getItem(LS_DISPLAY) || 'word';
	let currentPictogramId = null;
	
// Pinned IDs (persisted)
const LS_PINNED = 'qr-word-game:pinned-ids';
let pinnedIds = {};
try { pinnedIds = JSON.parse(localStorage.getItem(LS_PINNED) || '{}'); } catch(e) { pinnedIds = {}; }
function setPinned(word, id) {
	const w = (word||'').toLowerCase().trim();
	if (!w || !id) return;
	pinnedIds[w] = id;
	try { localStorage.setItem(LS_PINNED, JSON.stringify(pinnedIds)); } catch(e) {}
}

	
	// Initialize display mode
	for (const r of displayRadios) {
		if (r.value === displayMode) r.checked = true;
	}
	
	// Initialize mute button
	muteBtn.textContent = isMuted ? '🔇' : '🔊';
	
	// Sound generation
	function initAudio() {
		if (!audioContext) {
			audioContext = new (window.AudioContext || window.webkitAudioContext)();
		}
	}
	
	function playSound(frequency, duration, type = 'sine') {
		if (isMuted) return;
		
		try {
			initAudio();
			const oscillator = audioContext.createOscillator();
			const gainNode = audioContext.createGain();
			
			oscillator.connect(gainNode);
			gainNode.connect(audioContext.destination);
			
			oscillator.type = type;
			oscillator.frequency.value = frequency;
			
			gainNode.gain.setValueAtTime(0.3, audioContext.currentTime);
			gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + duration);
			
			oscillator.start(audioContext.currentTime);
			oscillator.stop(audioContext.currentTime + duration);
		} catch(e) {
			console.log('Audio not available');
		}
	}
	
	function playCorrectSound() {
		setTimeout(() => playSound(523, 0.1), 0);    // C
		setTimeout(() => playSound(659, 0.1), 100);  // E
		setTimeout(() => playSound(784, 0.2), 200);  // G
	}
	
	function playMilestoneSound() {
		setTimeout(() => playSound(523, 0.1), 0);    // C
		setTimeout(() => playSound(659, 0.1), 100);  // E
		setTimeout(() => playSound(784, 0.1), 200);  // G
		setTimeout(() => playSound(1047, 0.3), 300); // High C
	}
	
	muteBtn.addEventListener('click', () => {
		isMuted = !isMuted;
		muteBtn.textContent = isMuted ? '🔇' : '🔊';
		localStorage.setItem(LS_MUTED, isMuted.toString());
		toast(isMuted ? 'Sound muted' : 'Sound enabled');
	});
	
	// Display mode toggle
	displayRadios.forEach(r => r.addEventListener('change', () => {
		displayMode = r.value;
		localStorage.setItem(LS_DISPLAY, displayMode);
		updateDisplay(wordEl.textContent);
	}));

	// Check for native BarcodeDetector support
	if ('BarcodeDetector' in window) {
		BarcodeDetector.getSupportedFormats().then(formats => {
			if (formats.includes('qr_code')) {
				barcodeDetector = new BarcodeDetector({ formats: ['qr_code'] });
				console.log('Using native BarcodeDetector');
			}
		});
	}

	// Word management
	function loadWords(){
		const saved = localStorage.getItem(LS_KEY);
		if(saved) wordListTA.value = saved;
		const lines = wordListTA.value.split(/[\r\n]+/).map(s=>s.trim()).filter(Boolean);
		const seen = new Set();
		return lines.filter(word => {
			const lower = word.toLowerCase();
			if (seen.has(lower)) return false;
			seen.add(lower);
			return true;
		});
	}
	
	function saveWords(){
		localStorage.setItem(LS_KEY, wordListTA.value);
		words = loadWords();
		usedWords = [];
		toast("Saved " + words.length + " words!");
	}
	
	// Load validated words from ARASAAC
	async function loadArasaacWords() {
		loadingMsg.style.display = 'block';
		loadArasaacBtn.disabled = true;
		
		try {
			// Common Spanish words to search for
			const searchTerms = [
				'casa', 'perro', 'gato', 'coche', 'árbol', 'sol', 'luna', 'agua', 
				'libro', 'mesa', 'silla', 'cama', 'puerta', 'ventana', 'escuela',
				'niño', 'niña', 'mamá', 'papá', 'comer', 'beber', 'dormir', 'jugar',
				'correr', 'saltar', 'leer', 'escribir', 'uno', 'dos', 'tres', 'cuatro',
				'cinco', 'rojo', 'azul', 'verde', 'amarillo', 'grande', 'pequeño',
				'feliz', 'triste', 'caliente', 'frío', 'día', 'noche', 'amigo'
			];
			
			const validWords = [];
			
			// Use a proxy to avoid CORS issues
			const proxyUrl = 'https://api.allorigins.win/raw?url=';
			
			for (const term of searchTerms) {
				try {
					const url = `https://api.arasaac.org/v1/pictograms/es/bestsearch/${encodeURIComponent(term)}`;
					const response = await fetch(proxyUrl + encodeURIComponent(url));
					
					if (response.ok) {
						const data = await response.json();
						if (data && data.length > 0) {
							validWords.push(term);
						}
					}
				} catch (e) {
					console.log(`Could not validate: ${term}`);
				}
				
				// Small delay to avoid overwhelming the API
				await new Promise(resolve => setTimeout(resolve, 100));
			}
			
			if (validWords.length > 0) {
				wordListTA.value = validWords.join('\n');
				saveWords();
				toast(`Loaded ${validWords.length} validated ARASAAC words!`);
			} else {
				// Fallback to known good words
				const fallbackWords = [
					'gato', 'perro', 'casa', 'sol', 'luna', 'agua', 'árbol',
					'libro', 'mesa', 'silla', 'coche', 'niño', 'niña',
					'comer', 'dormir', 'jugar', 'uno', 'dos', 'tres'
				];
				wordListTA.value = fallbackWords.join('\n');
				saveWords();
				toast('Loaded default ARASAAC words');
			}
		} catch (error) {
			console.error('Error loading ARASAAC words:', error);
			toast('Could not load ARASAAC words');
		} finally {
			loadingMsg.style.display = 'none';
			loadArasaacBtn.disabled = false;
		}
	}
	
	loadArasaacBtn.addEventListener('click', loadArasaacWords);
	
	function downloadWords(){
		const text = wordListTA.value;
		const timestamp = new Date().toISOString().slice(0, 10);
		const filename = `qr-words-${timestamp}.txt`;
		
		if (navigator.share && /mobile|android|iphone|ipad/i.test(navigator.userAgent)) {
			const blob = new Blob([text], { type: 'text/plain' });
			const file = new File([blob], filename, { type: 'text/plain' });
			
			navigator.share({
				files: [file],
				title: 'QR Word List',
				text: 'Word list for QR matching game'
			}).then(() => {
				toast("Shared successfully!");
			}).catch(err => {
				if (err.name !== 'AbortError') {
					fallbackDownload(text, filename);
				}
			});
		} else {
			fallbackDownload(text, filename);
		}
	}
	
	function fallbackDownload(text, filename) {
		const blob = new Blob([text], { type: 'text/plain' });
		const url = URL.createObjectURL(blob);
		const a = document.createElement('a');
		a.href = url;
		a.download = filename;
		a.style.display = 'none';
		document.body.appendChild(a);
		a.click();
		setTimeout(() => {
			document.body.removeChild(a);
			URL.revokeObjectURL(url);
		}, 100);
		toast("Downloaded: " + filename);
	}
	
	function loadFromFile(e){
		const file = e.target.files[0];
		if (!file) return;
		
		const reader = new FileReader();
		reader.onload = function(event) {
			wordListTA.value = event.target.result;
			saveWords();
			words = loadWords();
			usedWords = [];
			toast("Loaded " + words.length + " words from file!");
			setWord(randomWord());
		};
		reader.readAsText(file);
	}
	
	saveWordsBtn.addEventListener('click', saveWords);
	downloadWordsBtn.addEventListener('click', downloadWords);
	uploadBtn.addEventListener('click', () => fileInput.click());
	fileInput.addEventListener('change', loadFromFile);

	let words = loadWords();
	let usedWords = [];
	
	function randomWord(){ 
		if(words.length===0){words=["gato"];} 
		
		if (usedWords.length >= words.length) {
			usedWords = [];
			console.log('All words used, resetting list');
		}
		
		const availableWords = words.filter(w => !usedWords.includes(w));
		const word = availableWords[Math.floor(Math.random() * availableWords.length)];
		usedWords.push(word);
		
		return word;
	}
	
	function setWord(w){ 
		lastText = null;
		updateDisplay(w);
	}
	
	function updateDisplay(word) {
		wordEl.textContent = word;
		statusEl.textContent = ""; 
		statusEl.className = "status";
		
		if (displayMode === 'pictogram') {
			wordEl.style.display = 'none';
			pictogramEl.style.display = 'block';
			fetchPictogramFromAPI(word);
		} else {
			wordEl.style.display = 'block';
			pictogramEl.style.display = 'none';
		}
	}
	
	// Fetch pictogram using ARASAAC API with bestsearch (with caching and rate limiting)
	const pictogramCache = new Map();
	let lastAPICall = 0;
	const API_DELAY = 500; // Minimum 500ms between API calls
	
	
async function resolvePictogramId(word){
	const w = (word||'').toLowerCase().trim();
	const nd = w.normalize('NFD').replace(/\p{Diacritic}/gu, '');
	if (pinnedIds[w]) return pinnedIds[w];
	if (pinnedIds[nd]) return pinnedIds[nd];
	if (fallbackIds[w]) return fallbackIds[w];
	if (fallbackIds[nd]) return fallbackIds[nd];
	const workerBase = 'https://frosty-snowflake-66a2.john-zwicker.workers.dev';
	const workerURL = `${workerBase}/bestsearch?q=${encodeURIComponent(w)}`;
	const workerURLAlt = `${workerBase}/bestsearch?q=${encodeURIComponent(nd)}`;
	let response = null;
	try { response = await fetch(workerURL, {mode:'cors'}); } catch(e) { response = null; }
	if (!response || !response.ok) { try { response = await fetch(workerURLAlt, {mode:'cors'}); } catch(e) { response = null; } }
	if (!response || !response.ok) {
		const apiURL = `https://api.arasaac.org/v1/pictograms/es/bestsearch/${encodeURIComponent(w)}`;
		const apiURLAlt = `https://api.arasaac.org/v1/pictograms/es/bestsearch/${encodeURIComponent(nd)}`;
		try { response = await fetch(apiURL, {mode:'cors'}); } catch(e) { response = null; }
		if (!response || !response.ok) { try { response = await fetch(apiURLAlt, {mode:'cors'}); } catch(e) { response = null; } }
	}
	if (response && response.ok) {
		try {
			const items = await response.json();
			if (Array.isArray(items) && items.length>0){
				const top = items.slice(0,6);
				for (const it of top){
					const pid = it._id || it.id;
					try {
						const meta = await fetch(`https://api.arasaac.org/v1/pictograms/es/${pid}`, {mode:'cors'});
						if (meta.ok){
							const pdata = await meta.json();
							const kws = (pdata.keywords||[]).map(k => (k.keyword||'').toLowerCase());
							const kwsNd = kws.map(x=>x.normalize('NFD').replace(/\p{Diacritic}/gu,''));
							if (kws.includes(w) || kwsNd.includes(nd)) return pid;
						}
					} catch(e){}
				}
				return top[0]._id || top[0].id;
			}
		} catch(e){}
	}
	return null;
}

async function fetchPictogramFromAPI(word) {
		pictogramEl.innerHTML = '<div>Loading pictogram...</div>';
		
		try {
			const cleanWord = word.toLowerCase().trim();
			
			// Check cache first
			if (pictogramCache.has(cleanWord)) {
				const cachedId = pictogramCache.get(cleanWord);
				displayPictogram(cachedId, word);
				return;
			}
			
			// Rate limiting - wait if needed
			const now = Date.now();
			const timeSinceLastCall = now - lastAPICall;
			if (timeSinceLastCall < API_DELAY) {
				await new Promise(resolve => setTimeout(resolve, API_DELAY - timeSinceLastCall));
			}
			lastAPICall = Date.now();
			
			// Try using a CORS proxy for the API call
			const proxyUrl = 'https://api.allorigins.win/raw?url=';
			const apiUrl = `https://api.arasaac.org/v1/pictograms/es/bestsearch/${encodeURIComponent(cleanWord)}`;
			
			try {
				const response = await fetch(proxyUrl + encodeURIComponent(apiUrl));
				
				if (response.ok) {
					const items = await response.json();
					
					if (items && items.length > 0) {
						// Use the first result
						const pictogramId = items[0]._id || items[0].id;
						pictogramCache.set(cleanWord, pictogramId);
						displayPictogram(pictogramId, word);
						return;
					}
				}
			} catch (e) {
				console.log('API call failed, using fallback');
			}
			
			// Use fallback if API fails
			useFallbackPictogram(cleanWord, word);
			
		} catch (error) {
			console.error('Error loading pictogram:', error);
			pictogramEl.innerHTML = `<div style="font-size: 48px; font-weight: bold;">${word}</div>`;
		}
	}
	
	function displayPictogram(pictogramId, word) {
		currentPictogramId = pictogramId;
		
		// Direct PNG URL (500px version)
		const imgUrl = `https://static.arasaac.org/pictograms/${pictogramId}/${pictogramId}_500.png`;
		
		pictogramEl.innerHTML = `
			<img src="${imgUrl}" 
				 alt="${word}" 
				 onerror="this.onerror=null; this.src='https://api.arasaac.org/v1/pictograms/${pictogramId}?download=false&color=true';">
		`;
		
		console.log(`Loaded pictogram for "${word}" with ID: ${pictogramId}`);
	}
	
	function useFallbackPictogram(cleanWord, word) {
		// Fallback to hardcoded IDs if API fails
		const fallbackIds = {
			'gato': 7114,
			'perro': 2517,
			'ratón': 2546,
			'raton': 2546,
			'castillo': 5421,
			'elefante': 2372,
			'tres': 2629,
			'casa': 2433,
			'sol': 2435,
			'luna': 2411,
			'agua': 2244,
			'árbol': 2418,
			'arbol': 2418,
			'libro': 2390,
			'mesa': 2412,
			'silla': 2632,
			'coche': 2446,
			'uno': 2627,
			'dos': 2628,
			'cuatro': 2630,
			'cinco': 2631
		};
		
		const fallbackId = fallbackIds[cleanWord];
		if (fallbackId) {
			pictogramCache.set(cleanWord, fallbackId);
			displayPictogram(fallbackId, word);
		} else {
			// Show emoji or text fallback
			const emojiMap = {
				'gato': '🐱', 'perro': '🐕', 'ratón': '🐭', 'elefante': '🐘',
				'casa': '🏠', 'castillo': '🏰', 'sol': '☀️', 'luna': '🌙',
				'estrella': '⭐', 'árbol': '🌳', 'agua': '💧', 'fuego': '🔥',
				'coche': '🚗', 'libro': '📚', 'pelota': '⚽'
			};
			
			const emoji = emojiMap[cleanWord];
			if (emoji) {
				pictogramEl.innerHTML = `<div style="font-size: 120px;">${emoji}</div>`;
			} else {
				pictogramEl.innerHTML = `<div style="font-size: 48px; font-weight: bold;">${word}</div>`;
			}
		}
	}

	function normalize(s){
		if(modeSel.value==="exact") return s.trim();
		return s.normalize("NFD").replace(/\p{Diacritic}/gu,"").toLowerCase().trim();
	}
	
	function celebrate(){
		if (typeof confetti === 'function') {
			confetti({ particleCount: 90, spread: 65, origin: { y: 0.6 } });
		}
	}
	
	function megaCelebrate(){
		if (typeof confetti === 'function') {
			// Multiple bursts for big milestone
			const count = 300; // More confetti!
			const defaults = { origin: { y: 0.7 } };
			
			function fire(particleRatio, opts) {
				confetti({
					...defaults,
					...opts,
					particleCount: Math.floor(count * particleRatio)
				});
			}
			
			// Fire multiple times for huge celebration
			fire(0.25, { spread: 26, startVelocity: 55 });
			fire(0.2, { spread: 60 });
			fire(0.35, { spread: 100, decay: 0.91, scalar: 0.8 });
			fire(0.1, { spread: 120, startVelocity: 25, decay: 0.92, scalar: 1.2 });
			fire(0.1, { spread: 120, startVelocity: 45 });
			
			// Extra bursts for more celebration
			setTimeout(() => {
				fire(0.25, { spread: 23, startVelocity: 45 });
				fire(0.35, { spread: 80, decay: 0.91 });
			}, 200);
			
			setTimeout(() => {
				fire(0.25, { spread: 26, startVelocity: 65 });
			}, 400);
		}
	}
	
	function showBigNumber(num) {
		const el = document.createElement('div');
		el.id = 'bigMilestone';
		el.textContent = num;
		document.body.appendChild(el);
		setTimeout(() => el.remove(), 1500);
	}
	
	function updateStars() {
		const recentStars = correctWords.slice(-10).map(() => '⭐').join('');
		starsEl.innerHTML = recentStars;
		
		if (correctWords.length > 0) {
			starsEl.style.animation = 'none';
			setTimeout(() => {
				starsEl.style.animation = 'pulse 0.5s ease-in-out';
			}, 10);
		}
	}
	
	function updateScore(ok){
		if(ok){ 
			score += 1; 
			streak += 1;
			correctWords.push(wordEl.textContent);
			updateStars();
			
			playCorrectSound();
			
			if (streak === 3) {
				toast("🎉 3 in a row! Great job!");
				celebrate();
				showBigNumber(3);
			} else if (streak === 10) {
				toast("🏆 10 STREAK! AMAZING!");
				megaCelebrate();
				playMilestoneSound();
				showBigNumber(10);
			} else if (streak === 20) {
				toast("🌟 20 STREAK! YOU'RE A CHAMPION!");
				megaCelebrate();
				playMilestoneSound();
				showBigNumber(20);
			} else if (streak % 5 === 0 && streak > 0) {
				toast(`🔥 ${streak} streak! Keep going!`);
				celebrate();
			}
		} else { 
			streak = 0; 
		}
		scoreTag.textContent = "Score: " + score;
		streakTag.textContent = "Streak: " + streak + " 🔥";
	}
	
	function toast(msg){
		const el = document.createElement('div');
		el.textContent = msg;
		el.style.cssText = "position:fixed;bottom:16px;left:50%;transform:translateX(-50%);background:#111722;border:1px solid #1c2432;padding:8px 12px;border-radius:999px;color:white;box-shadow:0 8px 30px rgba(0,0,0,.4);z-index:9999";
		document.body.appendChild(el);
		setTimeout(()=> el.remove(), 2000);
	}

	// QR Code detection
	async function scanFrame() {
		if (!scanning || !video.videoWidth) return;

		canvas.width = video.videoWidth;
		canvas.height = video.videoHeight;
		ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

		try {
			let decodedText = null;

			if (barcodeDetector) {
				const barcodes = await barcodeDetector.detect(canvas);
				if (barcodes.length > 0) {
					decodedText = barcodes[0].rawValue;
				}
			} else if (typeof jsQR !== 'undefined') {
				const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
				const code = jsQR(imageData.data, imageData.width, imageData.height);
				if (code) {
					decodedText = code.data;
				}
			}

			if (decodedText && decodedText !== lastText) {
				lastText = decodedText;
				const currentWord = wordEl.textContent;
				const ok = normalize(decodedText) === normalize(currentWord);
				updateScore(ok);
				
				if (ok) {
					statusEl.textContent = "✓ Correct: " + decodedText;
					statusEl.className = "status ok";
					celebrate();
					
					setTimeout(() => {
						setWord(randomWord());
						lastText = null;
					}, 1000);
				} else {
					statusEl.textContent = "✖ Not matched: " + decodedText;
					statusEl.className = "status bad";
				}
			}
		} catch (err) {
			// Silently handle scan errors
		}
	}

	// Camera controls - always use back camera
	async function start() {
		if (scanning) return;
		
		try {
			errEl.textContent = "";
			
			const constraints = {
				video: {
					facingMode: 'environment',
					width: { ideal: 1280 },
					height: { ideal: 720 }
				}
			};

			if (stream) {
				stream.getTracks().forEach(track => track.stop());
				stream = null;
			}

			stream = await navigator.mediaDevices.getUserMedia(constraints);
			video.srcObject = stream;
			await video.play();
			
			videoContainer.style.display = 'block';
			scanning = true;
			startBtn.disabled = true;
			stopBtn.disabled = false;
			nextBtn.disabled = true;

			if (scanInterval) clearInterval(scanInterval);
			scanInterval = setInterval(scanFrame, 100);
			
		} catch (err) {
			let errorMsg = "Camera error: " + (err.message || err);
			
			if (err.name === 'NotAllowedError') {
				errorMsg = `📷 Camera blocked. Click the lock icon in address bar → Camera → Allow → Refresh`;
			} else if (err.name === 'NotFoundError') {
				errorMsg = "No camera detected";
			} else if (err.name === 'NotReadableError') {
				errorMsg = "Camera is in use by another app";
			}
			
			errEl.textContent = errorMsg;
			scanning = false;
			startBtn.disabled = false;
			stopBtn.disabled = true;
		}
	}

	async function stop() {
		if (!scanning) return;
		
		scanning = false;
		
		if (scanInterval) {
			clearInterval(scanInterval);
			scanInterval = null;
		}
		
		if (stream) {
			stream.getTracks().forEach(track => track.stop());
			stream = null;
		}
		
		video.srcObject = null;
		videoContainer.style.display = 'none';
		startBtn.disabled = false;
		stopBtn.disabled = true;
		nextBtn.disabled = false;
		lastText = null;
	}

	// Event listeners
	startBtn.addEventListener('click', start);
	stopBtn.addEventListener('click', stop);
	nextBtn.addEventListener('click', () => setWord(randomWord()));

	// Initialize
	setWord(randomWord());
	</script>
</body>
</html>